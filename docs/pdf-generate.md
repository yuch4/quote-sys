

## 仕様書：HTML/CSSテンプレートから見積書PDF生成（Next.js + Supabase）

### 1. 目的
Webアプリ上で、管理者が編集可能なHTML/CSSテンプレートを用いて見積書PDFを生成し、承認ワークフロー完了後に押印（担当印・角印）した最終版PDFを配布（ダウンロード・メール送付・取引先ポータル閲覧）できるようにする。

---

## 2. スコープ

### 2.1 対象
* 見積書のPDF生成（HTML/CSS → PDF）
* テンプレート管理（管理者編集、プレビュー）
* 承認ワークフロー（担当部署・同一部署の課長/部長、金額条件でルート分岐）
* 押印（担当印：ユーザーごと、角印：共通）
* 最終版PDFの保存・配布（取引先ポータル含む）
* 監査ログ（承認・押印・配布イベント）

### 2.2 対象外（初期）
* PDFの暗号学的電子署名（PKI）
* WYSIWYG帳票エディタ（テンプレ編集はHTML/CSSベース）
* 中間版PDFの外部公開（最終版のみ取引先に公開）

---

## 3. 用語
| 用語 | 意味 |
|---|---|
| テンプレート | 見積書PDFのレイアウト定義（HTML/CSS + 変数差し込み） |
| 差し込み | テンプレート内のプレースホルダに見積データを展開する処理（例：Handlebars） |
| 最終承認 | ワークフロー上の最後の承認ステップ（課長の場合も部長の場合もある） |
| 担当印 | 承認者個人に紐づく印影（ユーザーごと） |
| 角印 | 共通の印影（システム共通） |

---

## 4. 主要要件

### 4.1 PDF生成（自由レイアウト）
* テンプレートはHTML/CSSで記述できること
* A4縦、mm指定の余白を利用可能であること
* 明細行の増減に対応し、改ページ制御（`break-*`等）をテンプレ側で調整可能であること
* 背景色・罫線等をPDFに反映できること（印刷背景有効）
* 日本語が文字化けせず、レイアウト崩れを抑えるためフォントを固定できること

### 4.2 テンプレート管理（管理者編集）
* 管理者はテンプレートを新規作成/編集/複製/無効化できること
* テンプレートはバージョン管理できること（更新履歴）
* サンプルデータでHTMLプレビュー、PDFプレビューができること
* テンプレートに利用可能な変数（スキーマ）が明示されること

### 4.3 承認ワークフロー（可変・金額条件）
* 見積の担当部署 `departmentId` に基づき同一部署の役職者で承認者を確定すること
* 課長/部長が複数いる場合、主担当フラグで一意に解決すること
* 金額条件：
    * \( \le ¥1,000,000 \)：課長承認で最終
    * \( > ¥1,000,000 \)：課長→部長の順で最終
* ワークフローマスタにより、将来ルールを追加できること（可変）

### 4.4 押印
* 担当印欄：固定3枠（slot1〜slot3）
* 角印：固定1箇所
* 担当印はユーザーごとの印影を使用すること
* 角印は共通印影を使用すること
* 最終版PDFのみ配布するため、押印は**最終承認完了時に一括反映**すること
    * ただし承認ログとして「誰が承認したか」は必ず保持する

### 4.5 配布
* 社内：最終版PDFをダウンロード可能
* 取引先ポータル：権限のある取引先ユーザーのみ閲覧可能
* メール送付：基本は「閲覧リンク（期限付き）」送付（運用上必要なら添付も可）
* 最終版PDFは再生成しない（固定ファイルとして保存）

---

## 5. 画面/機能仕様（概要）

### 5.1 管理者：テンプレート管理
* 一覧：名称、状態（有効/無効）、バージョン、更新日時、更新者
* 編集：HTML、CSS、利用可能変数一覧、プレビュー（HTML/PDF）
* 公開：有効化（運用テンプレとして採用）

### 5.2 見積：作成/申請/承認
* 作成：見積データ入力、テンプレ選択
* 申請：申請時にスナップショット固定（内容変更は再申請）
* 承認：課長/部長が承認実行
* 最終化：最終承認時に押印済みPDF生成・保存・配布可能状態へ

### 5.3 取引先ポータル
* 見積一覧（取引先に紐づく見積のみ）
* 見積詳細：最終版PDFの閲覧/ダウンロード

---

## 6. テンプレート仕様

### 6.1 テンプレ形式
* HTML：全文HTML（`<!doctype html><html>...`）を基本とする
* CSS：HTML内`<style>`または別フィールド（推奨：別フィールド）
* 差し込み：テンプレエンジン（例：Handlebars想定）

### 6.2 変数（例）
| 変数 | 型 | 説明 |
|---|---|---|
| `quoteNo` | string | 見積番号 |
| `issuedAt` | string | 発行日（表示用） |
| `customerName` | string | 宛名 |
| `items[]` | array | 明細 |
| `items[].name` | string | 品目 |
| `items[].qty` | number | 数量 |
| `items[].unitPrice` | number | 単価 |
| `items[].lineTotal` | number | 金額（事前計算） |
| `total` | number | 合計 |
| `stamps` | object | 押印関連（最終版生成時のみ利用） |

### 6.3 レイアウト推奨CSS（帳票）
* `@page { size: A4; margin: ...mm; }`
* `thead { display: table-header-group; }`
* `tr { break-inside: avoid; }`
* `printBackground`有効を前提に色調整

### 6.4 テンプレ制約（セキュリティ）
* `script`タグ禁止
* 外部リソース参照（外部URLの画像/フォント/CSS）は原則禁止（許可制にする場合はドメインallowlist）
* 使用可能な差し込みキーをallowlist管理（想定外データ参照を不可にする）

---

## 7. PDF生成仕様

### 7.1 生成方式
* Headless Chromiumの印刷機能でPDF生成（HTML/CSSをレンダリングしてPDF化）
* 実行環境はNode.js runtime（Edge runtimeは不可）

### 7.2 出力仕様
* 用紙：A4
* 余白：テンプレまたはシステム既定（mm）
* 背景：出力に含める（印刷背景ON）
* ページ番号：必要に応じてフッタに付与（`pageNumber / totalPages`）

### 7.3 フォント
* 日本語フォントを固定できること
* 本番はフォントを同梱し、`@font-face`で参照することを推奨

---

## 8. 押印仕様

### 8.1 押印種別
| 種別 | 画像 | 対象 | 位置 |
|---|---|---|---|
| 担当印 | ユーザー別 | 承認者（課長/部長等） | 固定3枠（slot1-3） |
| 角印 | 共通 | 最終承認者 | 固定1箇所 |

### 8.2 押印タイミング
* 最終承認完了時に、承認履歴を参照して押印を一括反映し最終版PDFを生成・保存する

### 8.3 印影の版管理
* 角印：共通印影はversion管理（差し替え可能、旧版保持）
* 担当印：ユーザー印影もversion管理（承認ログに使用versionを記録）

---

## 9. データモデル（Supabase Postgres）

### 9.1 マスタ系（例）
| テーブル | 概要 |
|---|---|
| `departments` | 部署 |
| `users` | ユーザー |
| `user_positions` | ユーザーの部署・役職・主担当フラグ |
| `workflow_definitions` | ワークフロー定義（version含む） |
| `workflow_rules` | 金額条件等でdefinitionを選ぶルール |
| `workflow_steps` | 定義内ステップ（課長/部長、slot、isFinal） |
| `templates` | HTML/CSSテンプレ（version含む） |

主担当制約（要件）：部署×役職で `is_primary=true` が同時に複数存在しないこと。

### 9.2 トランザクション系（例）
| テーブル | 概要 |
|---|---|
| `quotes` | 見積本体（draft） |
| `quote_snapshots` | 申請時スナップショット（承認対象の固定データ） |
| `quote_workflow_instances` | 見積ごとの実行ワークフロー |
| `quote_approvals` | 各ステップの承認結果 |
| `quote_files` | 最終PDFのstorage key、sha256等 |
| `audit_logs` | 監査ログ |

---

## 10. ファイルストレージ（Supabase Storage）

### 10.1 バケット例
| bucket | 用途 | 公開 |
|---|---|---|
| `quote-pdfs` | 最終版PDF | 非公開（署名URLで配布） |
| `stamp-assets` | 角印（共通） | 非公開 |
| `user-stamps` | 担当印（ユーザー別） | 非公開 |
| `template-assets` | ロゴ等（任意） | 原則非公開 |

### 10.2 配布方法
* 社内/取引先ともに、基本は署名付きURL（期限付き）で閲覧・DL
* 添付が必要な場合はサーバ側で取得して添付（運用要件で選択）

---

## 11. API仕様（概要）

### 11.1 テンプレ
* `GET /templates`（管理者）
* `POST /templates`（作成）
* `PUT /templates/:id`（編集）
* `POST /templates/:id/preview/html`
* `POST /templates/:id/preview/pdf`

### 11.2 見積・ワークフロー
* `POST /quotes`（作成/更新：draftのみ）
* `POST /quotes/:id/submit`（申請開始：スナップショット固定、instance生成）
* `POST /quotes/:id/approve`（承認：現在stepの承認、冪等）
* `POST /quotes/:id/finalize`（最終化：最終承認時のみ、最終PDF生成・保存）
    * 実装上は `approve` 内で最終化してもよい（仕様としては「最終承認時に最終PDFが確定する」ことを満たせば可）
* `GET /quotes/:id/pdf`（最終版PDF取得：社内/取引先権限制御）

### 11.3 メール送付
* `POST /quotes/:id/send`（最終版のみ送付可能）

---

## 12. 権限・RLS（Supabase）

### 12.1 権限ロール（例）
* `admin`：テンプレ編集、角印管理、全監査閲覧
* `employee`：自部署見積の作成/申請、承認（役職条件）
* `partner`：取引先ポータル閲覧（紐づく見積のみ）

### 12.2 Storageアクセス
* バケットは非公開
* 署名付きURLの発行はサーバ側（権限制御下）で実行

---

## 13. 監査ログ（必須イベント）
* 見積作成/更新（draft）
* submit（スナップショット確定、適用ルール）
* 各承認（承認者、役職、日時）
* 最終PDF生成（`finalPdfKey`、`sha256`、使用した印影version）
* メール送付（送付先、送付者、日時）
* 取引先閲覧/ダウンロード（必要なら）

---

## 14. エラー仕様（例）
* 主担当が解決できない（課長/部長のprimary不在・複数）：承認不可（設定不備）
* 申請中に見積が編集された：承認無効化→再申請要求
* 最終PDF生成失敗：最終化失敗としてリトライ可能（冪等キーで二重生成を防止）
* 印影画像が取得できない：最終化中断（運用データ不整合）

---

## 15. 非機能要件
* 可用性：最終PDFは保存済みを配布し、閲覧負荷をPDF生成に依存しない
* 性能：PDF生成は最終承認時のみ（頻度を抑制）
* 冪等性：承認/最終化は重複実行しても結果が一意
* セキュリティ：テンプレHTMLの危険要素排除、Storage非公開、監査ログ保持
* タイムゾーン：日時はAsia/Tokyoで表示、保存はUTCでも可（表示変換要）

---

## 16. 受け入れ基準（例）
* 管理者がHTML/CSSテンプレを編集し、プレビューPDFで反映を確認できる
* \( \le ¥1,000,000 \) は課長承認で最終化され、課長印（slot1）＋角印が押された最終PDFが保存される
* \( > ¥1,000,000 \) は課長→部長の承認完了後に最終化され、課長印（slot1）＋部長印（slot2）＋角印が押された最終PDFが保存される
* 承認中に見積を編集すると承認が無効化され、再申請が必要になる
* 取引先ポータルで最終版PDFのみ閲覧可能（ドラフトは不可）
* メール送付で最終版PDFへのリンク（期限付き）を送付できる

---

