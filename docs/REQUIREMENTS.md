# 見積システム 要件定義書

## 1. システム概要

### 1.1 目的
現状のExcel依存型の見積・計上管理業務を統合し、データの一元管理と業務効率化を実現する。

### 1.2 解決する課題
- **Excel依存の非効率**: 発注日・入荷日の更新に案件ごとにファイルを開く必要がある
- **データの分断**: 見積システム、Excel、販売システム、ノーツがバラバラ
- **多重入力・多重チェック**: 同じデータを4回扱う(見積→一覧→販売→ノーツ)
- **指図書の分断**: 紙ベースの計上指示がシステムと連携していない
- **リアルタイム性の欠如**: 進捗状況の把握に時間がかかる

### 1.3 期待効果
- **作業時間削減**: 月間35-40時間 → 3-4時間 (90%削減)
- **データ品質向上**: 転記ミスの防止、整合性の自動チェック
- **可視化**: 営業・事務双方がリアルタイムで案件状況を把握

---

## 2. 技術スタック

### 2.1 採用技術
| 領域 | 技術 | 理由 |
|------|------|------|
| フロントエンド | Next.js 15 (App Router) | React Server Components、高速な開発体験 |
| 認証 | Supabase Auth | メール/パスワード認証、役割管理 |
| データベース | Supabase (PostgreSQL) | リアルタイム機能、Row Level Security |
| ストレージ | Supabase Storage | 見積書PDF、添付ファイルの管理 |
| スタイリング | Tailwind CSS + shadcn/ui | 美しいUI、高速な開発 |
| 状態管理 | React Hook Form + Zod | フォームバリデーション |
| PDF生成 | @react-pdf/renderer | 見積書PDF作成 |
| Excel出力 | SheetJS (xlsx) | CSV/Excelエクスポート |
| 通知 | Supabase Realtime + Resend | リアルタイム通知、メール送信 |

### 2.2 開発環境
- **言語**: TypeScript
- **パッケージマネージャ**: pnpm
- **コード品質**: ESLint + Prettier
- **テスト**: Vitest + Playwright (E2E)
- **デプロイ**: Vercel

---

## 3. データモデル設計

### 3.1 ER図概要
```
案件 (projects)
  ↓ 1:N
見積 (quotes)
  ↓ 1:N
明細 (quote_items)
  ↓ 1:N
発注・入荷履歴 (procurement_logs)

案件 (projects)
  ↓ 1:N
計上申請 (billing_requests)
```

### 3.2 主要テーブル定義

#### 3.2.1 案件テーブル (projects)
| カラム名 | 型 | 必須 | 説明 |
|---------|---|------|------|
| id | uuid | ✓ | 主キー |
| project_number | text | ✓ | 案件番号(自動採番) |
| customer_id | uuid | ✓ | 顧客ID (外部キー) |
| project_name | text | ✓ | 案件名 |
| category | text | ✓ | 案件カテゴリ |
| department | text | ✓ | 部門 |
| sales_rep_id | uuid | ✓ | 営業担当者ID (外部キー) |
| status | enum | ✓ | ステータス(見積中/受注/失注/キャンセル) |
| created_at | timestamp | ✓ | 作成日時 |
| updated_at | timestamp | ✓ | 更新日時 |

#### 3.2.2 見積テーブル (quotes)
| カラム名 | 型 | 必須 | 説明 |
|---------|---|------|------|
| id | uuid | ✓ | 主キー |
| project_id | uuid | ✓ | 案件ID (外部キー) |
| quote_number | text | ✓ | 見積番号(自動採番) |
| version | int | ✓ | バージョン(改訂管理) |
| issue_date | date | ✓ | 発行日 |
| valid_until | date | - | 有効期限 |
| total_amount | decimal | ✓ | 合計金額(自動計算) |
| total_cost | decimal | ✓ | 合計仕入金額(自動計算) |
| gross_profit | decimal | ✓ | 粗利(自動計算) |
| approval_status | enum | ✓ | 承認ステータス(下書き/承認待ち/承認済み/却下) |
| approved_by | uuid | - | 承認者ID |
| approved_at | timestamp | - | 承認日時 |
| pdf_url | text | - | 見積書PDF URL |
| notes | text | - | 備考 |
| created_by | uuid | ✓ | 作成者ID |
| created_at | timestamp | ✓ | 作成日時 |
| updated_at | timestamp | ✓ | 更新日時 |

#### 3.2.3 明細テーブル (quote_items)
| カラム名 | 型 | 必須 | 説明 |
|---------|---|------|------|
| id | uuid | ✓ | 主キー |
| quote_id | uuid | ✓ | 見積ID (外部キー) |
| line_number | int | ✓ | 行番号 |
| product_name | text | ✓ | 品名 |
| description | text | - | 説明 |
| quantity | decimal | ✓ | 数量 |
| unit_price | decimal | ✓ | 提供単価 |
| amount | decimal | ✓ | 提供金額(自動計算) |
| supplier_id | uuid | - | 仕入先ID (外部キー) |
| cost_price | decimal | - | 仕入単価 |
| cost_amount | decimal | - | 仕入金額(自動計算) |
| gross_profit | decimal | - | 粗利(自動計算) |
| requires_procurement | boolean | ✓ | 仕入れ要否 |
| procurement_status | enum | - | 調達ステータス(未発注/発注済/入荷済) |
| ordered_at | timestamp | - | 発注日 |
| received_at | timestamp | - | 入荷日 |
| shipment_ready_date | date | - | 出荷可能日 |
| created_at | timestamp | ✓ | 作成日時 |
| updated_at | timestamp | ✓ | 更新日時 |

#### 3.2.4 計上申請テーブル (billing_requests)
| カラム名 | 型 | 必須 | 説明 |
|---------|---|------|------|
| id | uuid | ✓ | 主キー |
| project_id | uuid | ✓ | 案件ID (外部キー) |
| quote_id | uuid | ✓ | 見積ID (外部キー) |
| billing_month | date | ✓ | 計上予定月 |
| status | enum | ✓ | ステータス(申請中/承認済/却下/計上完了) |
| requested_by | uuid | ✓ | 申請者ID |
| requested_at | timestamp | ✓ | 申請日時 |
| reviewed_by | uuid | - | 承認者ID |
| reviewed_at | timestamp | - | 承認日時 |
| rejection_reason | text | - | 却下理由 |
| exported_to_sales_system | boolean | ✓ | 販売システム連携済み |
| exported_to_notes | boolean | ✓ | ノーツ連携済み |
| notes | text | - | 備考 |
| created_at | timestamp | ✓ | 作成日時 |
| updated_at | timestamp | ✓ | 更新日時 |

#### 3.2.5 発注・入荷履歴テーブル (procurement_logs)
| カラム名 | 型 | 必須 | 説明 |
|---------|---|------|------|
| id | uuid | ✓ | 主キー |
| quote_item_id | uuid | ✓ | 明細ID (外部キー) |
| action_type | enum | ✓ | アクション(発注/入荷/出荷準備完了) |
| action_date | date | ✓ | アクション日 |
| quantity | decimal | ✓ | 数量 |
| performed_by | uuid | ✓ | 実行者ID |
| notes | text | - | 備考 |
| created_at | timestamp | ✓ | 記録日時 |

#### 3.2.6 顧客テーブル (customers)
| カラム名 | 型 | 必須 | 説明 |
|---------|---|------|------|
| id | uuid | ✓ | 主キー |
| customer_code | text | ✓ | 顧客コード |
| customer_name | text | ✓ | 顧客名 |
| customer_name_kana | text | - | 顧客名カナ |
| postal_code | text | - | 郵便番号 |
| address | text | - | 住所 |
| phone | text | - | 電話番号 |
| email | text | - | メールアドレス |
| contact_person | text | - | 担当者名 |
| created_at | timestamp | ✓ | 作成日時 |
| updated_at | timestamp | ✓ | 更新日時 |

#### 3.2.7 仕入先テーブル (suppliers)
| カラム名 | 型 | 必須 | 説明 |
|---------|---|------|------|
| id | uuid | ✓ | 主キー |
| supplier_code | text | ✓ | 仕入先コード |
| supplier_name | text | ✓ | 仕入先名 |
| contact_person | text | - | 担当者名 |
| phone | text | - | 電話番号 |
| email | text | - | メールアドレス |
| payment_terms | text | - | 支払条件 |
| created_at | timestamp | ✓ | 作成日時 |
| updated_at | timestamp | ✓ | 更新日時 |

#### 3.2.8 ユーザーテーブル (users)
Supabase Authと連携
| カラム名 | 型 | 必須 | 説明 |
|---------|---|------|------|
| id | uuid | ✓ | 主キー (Supabase Auth UUID) |
| email | text | ✓ | メールアドレス |
| display_name | text | ✓ | 表示名 |
| department | text | - | 部門 |
| role | enum | ✓ | 役割(営業/営業事務/管理者) |
| is_active | boolean | ✓ | 有効フラグ |
| created_at | timestamp | ✓ | 作成日時 |
| updated_at | timestamp | ✓ | 更新日時 |

---

## 4. 機能要件

### 4.1 認証・認可

#### 4.1.1 ログイン・ログアウト
- メールアドレス + パスワード認証
- セッション管理
- パスワードリセット機能

#### 4.1.2 役割管理
| 役割 | 権限 |
|------|------|
| 営業 | 案件作成、見積作成・編集、計上申請、自分の案件の閲覧 |
| 営業事務 | 全案件閲覧、発注管理、入荷登録、計上承認、CSVエクスポート |
| 管理者 | 全権限 + ユーザー管理、マスタ管理 |

---

### 4.2 案件管理

#### 4.2.1 案件一覧
- **表示項目**: 案件番号、案件名、顧客名、営業担当、ステータス、作成日
- **フィルタ**: 営業担当、ステータス、顧客、期間
- **ソート**: 各カラムでソート可能
- **検索**: 案件名、顧客名での全文検索

#### 4.2.2 案件登録・編集
- **入力項目**: 
  - 顧客選択(マスタから選択 or 新規登録)
  - 案件名
  - 案件カテゴリ(ドロップダウン)
  - 部門(ドロップダウン)
  - 営業担当(ユーザーマスタから選択)
- **バリデーション**: 必須項目チェック
- **自動採番**: 案件番号の自動生成

#### 4.2.3 案件詳細
- 案件基本情報表示
- 紐づく見積一覧
- 計上申請履歴
- アクティビティログ

---

### 4.3 見積管理

#### 4.3.1 見積作成
- **ヘッダ情報入力**:
  - 案件選択
  - 発行日(デフォルト: 今日)
  - 有効期限
  - 備考
- **明細入力**:
  - 品名(自由入力)
  - 説明
  - 数量
  - 提供単価
  - 仕入先選択(仕入れありの場合)
  - 仕入単価
  - 仕入れ要否チェック
- **自動計算**:
  - 明細金額 = 数量 × 単価
  - 明細仕入金額 = 数量 × 仕入単価
  - 明細粗利 = 明細金額 - 明細仕入金額
  - 見積合計金額 = Σ明細金額
  - 見積合計仕入金額 = Σ明細仕入金額
  - 見積粗利 = 合計金額 - 合計仕入金額

#### 4.3.2 見積承認フロー
1. 営業が見積を作成し「承認依頼」
2. 上長に通知メール送信
3. 上長が承認 or 却下
4. 承認完了後、PDF自動生成
5. 営業に通知

#### 4.3.3 見積書PDF生成
- 見積番号、発行日、有効期限
- 顧客情報
- 明細一覧(品名、数量、単価、金額)
- 合計金額、消費税、総計
- 備考
- Supabase Storageに保存

#### 4.3.4 見積改訂
- 既存見積をコピーして新バージョン作成
- バージョン履歴管理
- 旧バージョンは参照のみ

---

### 4.4 発注・入荷管理

#### 4.4.1 発注候補一覧
- **表示条件**: 受注済み案件の仕入れ要明細で未発注のもの
- **表示項目**: 案件名、顧客名、明細、仕入先、数量、仕入金額
- **操作**: 
  - 複数明細を選択して一括発注登録
  - 発注日の一括設定
  - 発注データCSVエクスポート

#### 4.4.2 入荷登録
- **検索**: 案件名、顧客名、品名で検索
- **入力**: 
  - 入荷日(デフォルト: 今日)
  - 入荷数量
  - 出荷可能日
  - 備考
- **更新**: 明細の調達ステータスを「入荷済」に更新
- **通知**: 営業担当に入荷通知メール

#### 4.4.3 進捗ダッシュボード
- **表示**: 
  - 発注済・未入荷の明細一覧
  - 入荷待ち日数
  - 出荷可能予定日
- **アラート**: 
  - 発注から○日経過でアラート表示
  - 出荷可能日超過でアラート

---

### 4.5 計上管理

#### 4.5.1 営業ダッシュボード
- **今月計上予定サマリー**:
  - 計上確定済: ○件 / ○○百万円
  - 申請中: ○件 / ○○百万円
  - 申請可能: ○件 / ○○百万円 (緑色)
  - 明細未完了: ○件 / ○○百万円 (黄色)
- **計上申請可否の自動判定**:
  - 全明細が「入荷済」
  - 全明細に「出荷可能日」設定済み
  - 上記満たせば「申請可能」
- **操作**: 
  - 案件を選択して「計上申請」ボタン
  - 計上予定月を選択
  - 備考入力

#### 4.5.2 計上申請一覧(営業事務)
- **表示項目**: 
  - 申請日時
  - 営業担当
  - 案件名
  - 顧客名
  - 売上金額
  - 仕入金額
  - 粗利
  - 粗利率
  - 明細完了率(例: 5/5件 100%)
  - 最終入荷日
  - 最短出荷可能日
- **フィルタ**: 営業担当、計上月、ステータス
- **詳細確認**: 
  - 明細ごとの入荷状況を色分け表示
  - 緑: 完了、黄: 未完了
- **操作**: 
  - 個別承認 / 一括承認
  - 差し戻し + 理由入力
  - 承認時に営業へ通知メール

#### 4.5.3 計上確定・エクスポート
- **月次計上確定リスト**:
  - 承認済み案件を計上月でフィルタ
  - 売上・仕入・粗利の自動集計
- **CSVエクスポート**:
  - 販売管理システム連携用CSV
  - ノーツ連携用CSV
  - ボタン1つでダウンロード
- **エクスポート履歴**: 
  - いつ、誰が、何をエクスポートしたか記録
  - 重複エクスポート防止

---

### 4.6 マスタ管理

#### 4.6.1 顧客マスタ
- 一覧、登録、編集、削除(論理削除)
- 顧客コード自動採番
- CSV一括インポート

#### 4.6.2 仕入先マスタ
- 一覧、登録、編集、削除(論理削除)
- 仕入先コード自動採番
- CSV一括インポート

#### 4.6.3 ユーザー管理
- 一覧、登録、編集、無効化
- 役割設定
- パスワードリセット

---

### 4.7 通知機能

#### 4.7.1 メール通知
- 見積承認依頼
- 見積承認完了
- 計上申請
- 計上承認/却下
- 入荷完了

#### 4.7.2 システム内通知
- ベルアイコンで未読件数表示
- 通知一覧ドロワー
- 既読管理

---

### 4.8 レポート・分析

#### 4.8.1 売上分析
- 月次売上推移グラフ
- 営業担当別売上ランキング
- 顧客別売上ランキング
- 案件カテゴリ別売上

#### 4.8.2 粗利分析
- 月次粗利推移
- 営業担当別粗利率
- 案件別粗利率ランキング

---

## 5. 非機能要件

### 5.1 パフォーマンス
- ページ初期表示: 2秒以内
- 一覧表示: 1000件まで1秒以内
- CSVエクスポート: 10000件まで5秒以内

### 5.2 セキュリティ
- Supabase Row Level Security (RLS) による行レベルアクセス制御
- HTTPS通信必須
- XSS、CSRF対策
- パスワードポリシー: 8文字以上、英数字記号含む

### 5.3 可用性
- Vercel + Supabaseで99.9%以上
- 自動バックアップ(Supabase)

### 5.4 保守性
- TypeScriptによる型安全性
- コンポーネントの再利用性
- APIのバージョニング

### 5.5 ユーザビリティ
- レスポンシブデザイン(PC、タブレット対応)
- 直感的なUI/UX
- ローディング状態の明示
- エラーメッセージの分かりやすさ

---

## 6. システム構成

### 6.1 ディレクトリ構造
```
/
├── app/                      # Next.js App Router
│   ├── (auth)/              # 認証関連ページ
│   │   ├── login/
│   │   └── reset-password/
│   ├── (dashboard)/         # メインアプリ
│   │   ├── dashboard/       # ダッシュボード
│   │   ├── projects/        # 案件管理
│   │   ├── quotes/          # 見積管理
│   │   ├── procurement/     # 発注・入荷管理
│   │   ├── billing/         # 計上管理
│   │   └── settings/        # 設定・マスタ管理
│   └── api/                 # API Routes
├── components/              # Reactコンポーネント
│   ├── ui/                  # shadcn/ui コンポーネント
│   ├── forms/               # フォームコンポーネント
│   ├── tables/              # テーブルコンポーネント
│   └── layouts/             # レイアウトコンポーネント
├── lib/                     # ユーティリティ
│   ├── supabase/            # Supabaseクライアント
│   ├── hooks/               # カスタムフック
│   ├── utils/               # ユーティリティ関数
│   └── validations/         # Zodスキーマ
├── types/                   # TypeScript型定義
├── public/                  # 静的ファイル
└── supabase/                # Supabaseマイグレーション
    ├── migrations/
    └── seed.sql
```

### 6.2 状態管理戦略
- **サーバー状態**: Supabase Realtime + React Query
- **フォーム状態**: React Hook Form
- **UI状態**: React useState + Context (必要に応じて)

### 6.3 データフェッチング
- Server Components: 初期データ取得
- Client Components: インタラクティブな操作
- Supabase Realtime: リアルタイム更新

---

## 7. 開発フェーズ

### Phase 1: 基盤構築 (2-3週間)
- [ ] プロジェクトセットアップ
- [ ] Supabase初期設定
- [ ] 認証機能実装
- [ ] 基本レイアウト・ナビゲーション
- [ ] マスタ管理(顧客、仕入先、ユーザー)

### Phase 2: 見積機能 (3-4週間)
- [ ] 案件管理機能
- [ ] 見積作成・編集機能
- [ ] 明細入力UI
- [ ] 見積承認フロー
- [ ] 見積書PDF生成

### Phase 3: 発注・入荷管理 (2-3週間)
- [ ] 発注候補一覧
- [ ] 発注登録機能
- [ ] 入荷登録機能
- [ ] 進捗ダッシュボード
- [ ] CSVエクスポート

### Phase 4: 計上管理 (3-4週間)
- [ ] 営業ダッシュボード
- [ ] 計上申請機能
- [ ] 計上申請一覧(営業事務)
- [ ] 計上承認フロー
- [ ] 販売システム/ノーツ連携用CSV出力

### Phase 5: 通知・レポート (2週間)
- [ ] メール通知機能
- [ ] システム内通知
- [ ] 売上・粗利分析レポート

### Phase 6: テスト・改善 (2週間)
- [ ] 単体テスト
- [ ] E2Eテスト
- [ ] パフォーマンス最適化
- [ ] ユーザビリティ改善

### Phase 7: 移行・運用開始 (1週間)
- [ ] 既存データ移行
- [ ] ユーザートレーニング
- [ ] 本番リリース

**合計開発期間**: 約3-4ヶ月

---

## 8. 運用・保守

### 8.1 モニタリング
- Vercel Analytics
- Supabase Dashboard
- エラーログ収集 (Sentry推奨)

### 8.2 バックアップ
- Supabase自動バックアップ(日次)
- 重要データの定期的なエクスポート

### 8.3 アップデート
- セキュリティパッチの適用
- 機能追加・改善のイテレーション

---

## 9. 制約事項・前提条件

### 9.1 前提条件
- ユーザーはPCまたはタブレットでアクセス
- モダンブラウザ(Chrome, Edge, Safari最新版)
- インターネット接続必須

### 9.2 制約事項
- 販売管理システム・ノーツへの自動連携は将来対応(Phase1ではCSVエクスポート)
- 見積書フォーマットは1種類(将来的にテンプレート化)
- Excel明細の直接インポートは非対応(手動入力)

### 9.3 将来の拡張
- モバイルアプリ対応
- 販売システム・ノーツとのAPI連携
- AI活用(見積金額の自動提案、異常検知)
- ワークフロービルダー(承認フローのカスタマイズ)

---

## 10. 成功指標 (KPI)

| 指標 | 現状 | 目標 | 測定方法 |
|------|------|------|---------|
| 月末計上作業時間 | 16-24時間 | 2-3時間 | 作業時間計測 |
| 日常入荷管理時間 | 70分/日 | 9分/日 | 作業時間計測 |
| データ転記ミス | 月数件 | 0件 | エラー記録 |
| 計上申請から承認まで | 2-3日 | 数時間 | システムログ |
| Excel操作回数 | 月500-800回 | 0回 | 業務観察 |

---

## 付録

### A. 用語集
- **案件**: 顧客からの引き合い・商談の単位
- **見積**: 案件に対する提案と金額の提示
- **明細**: 見積の内訳(1行 = 1商品)
- **指図書**: 営業が計上を依頼する紙の書類(現行運用)
- **計上**: 売上・仕入を会計システムに記録すること

### B. 参考資料
- 現状業務フロー詳細: `/営業DX/見積システムの問題点.md`
- Supabase公式ドキュメント: https://supabase.com/docs
- Next.js公式ドキュメント: https://nextjs.org/docs
- shadcn/ui: https://ui.shadcn.com/
