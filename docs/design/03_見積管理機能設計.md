# 見積管理機能 詳細設計書

## 1. 機能概要

### 1.1 目的
案件に紐づく見積の作成、承認フロー管理、PDF生成を行い、見積業務の効率化と品質向上を実現する。

### 1.2 主要機能
- 見積の新規作成・編集・複製
- 明細の入力・計算（金額、仕入、粗利の自動計算）
- 見積承認フロー（下書き → 承認待ち → 承認済み / 却下）
- 見積書PDF自動生成（@react-pdf/renderer）
- バージョン管理（改訂履歴）
- 見積一覧・検索・フィルタリング

---

## 2. データモデル

### 2.1 quotesテーブル

```sql
CREATE TABLE public.quotes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES public.projects(id),
  quote_number TEXT NOT NULL UNIQUE,
  version INTEGER NOT NULL DEFAULT 1,
  issue_date DATE NOT NULL,
  valid_until DATE,
  subject TEXT,
  total_amount DECIMAL(15, 2) NOT NULL DEFAULT 0,
  total_cost DECIMAL(15, 2) NOT NULL DEFAULT 0,
  gross_profit DECIMAL(15, 2) NOT NULL DEFAULT 0,
  approval_status TEXT NOT NULL CHECK (approval_status IN ('下書き', '承認待ち', '承認済み', '却下')) DEFAULT '下書き',
  approved_by UUID REFERENCES public.users(id),
  approved_at TIMESTAMPTZ,
  pdf_url TEXT,
  pdf_generated_at TIMESTAMPTZ,
  previous_version_id UUID REFERENCES public.quotes(id),
  notes TEXT,
  created_by UUID NOT NULL REFERENCES public.users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### 2.2 quote_itemsテーブル

```sql
CREATE TABLE public.quote_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quote_id UUID NOT NULL REFERENCES public.quotes(id) ON DELETE CASCADE,
  line_number INTEGER NOT NULL,
  product_name TEXT NOT NULL,
  description TEXT,
  quantity DECIMAL(10, 2) NOT NULL,
  unit_price DECIMAL(15, 2) NOT NULL,
  amount DECIMAL(15, 2) NOT NULL,
  supplier_id UUID REFERENCES public.suppliers(id),
  cost_price DECIMAL(15, 2),
  cost_amount DECIMAL(15, 2),
  gross_profit DECIMAL(15, 2),
  requires_procurement BOOLEAN NOT NULL DEFAULT false,
  procurement_status TEXT CHECK (procurement_status IN ('未発注', '発注済', '入荷済')),
  ordered_at TIMESTAMPTZ,
  received_at TIMESTAMPTZ,
  shipment_ready_date DATE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (quote_id, line_number)
);
```

### 2.3 承認フローテーブル

```sql
CREATE TABLE public.quote_approval_instances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quote_id UUID NOT NULL REFERENCES public.quotes(id) ON DELETE CASCADE,
  route_id UUID NOT NULL REFERENCES public.approval_routes(id),
  status TEXT NOT NULL CHECK (status IN ('pending', 'approved', 'rejected', 'cancelled')) DEFAULT 'pending',
  current_step INTEGER,
  requested_by UUID REFERENCES public.users(id),
  requested_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  rejection_reason TEXT
);

CREATE TABLE public.quote_approval_instance_steps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  instance_id UUID NOT NULL REFERENCES public.quote_approval_instances(id) ON DELETE CASCADE,
  step_order INTEGER NOT NULL,
  approver_role TEXT NOT NULL CHECK (approver_role IN ('営業', '営業事務', '管理者')),
  approver_user_id UUID REFERENCES public.users(id),
  status TEXT NOT NULL CHECK (status IN ('pending', 'approved', 'rejected', 'skipped')) DEFAULT 'pending',
  decided_at TIMESTAMPTZ,
  notes TEXT
);
```

---

## 3. 画面設計

### 3.1 見積一覧画面（/dashboard/quotes）

#### 表示項目
- 見積番号、バージョン、件名、案件名、顧客名
- 承認ステータス、金額、粗利、発行日、作成日

#### 機能
- 検索（見積番号、件名、案件名、顧客名）
- フィルタ（承認ステータス、営業担当、期間）
- ソート
- 新規見積作成ボタン

### 3.2 見積作成画面（/dashboard/quotes/new）

#### 基本情報入力
- 案件選択（必須）
- 件名（必須）
- 発行日（デフォルト: 今日）
- 有効期限（デフォルト: 1ヶ月後）
- 備考

#### 明細入力（テーブル形式）
- 品名（必須）
- 説明
- 数量（必須）
- 提供単価（必須）
- 提供金額（自動計算）
- 仕入先選択
- 仕入単価
- 仕入金額（自動計算）
- 粗利（自動計算）
- 仕入要否チェックボックス

#### 自動計算ロジック

```typescript
// 明細レベル
const amount = quantity * unit_price
const cost_amount = quantity * cost_price
const gross_profit = amount - cost_amount

// 見積レベル
const total_amount = items.reduce((sum, item) => sum + item.amount, 0)
const total_cost = items.reduce((sum, item) => sum + item.cost_amount, 0)
const gross_profit = total_amount - total_cost
```

#### 見積番号の自動採番

```typescript
const generateQuoteNumber = async () => {
  const supabase = createClient()
  const year = new Date().getFullYear()
  const { count } = await supabase
    .from('quotes')
    .select('*', { count: 'exact', head: true })
  
  const nextNumber = (count || 0) + 1
  return `Q-${year}-${String(nextNumber).padStart(4, '0')}`
}

// 例: Q-2025-0001
```

### 3.3 見積詳細画面（/dashboard/quotes/[id]）

#### 表示内容
- 見積ヘッダ情報（見積番号、件名、案件、顧客、承認ステータス）
- 明細一覧（品名、数量、単価、金額、粗利）
- 合計（合計金額、合計仕入、粗利、粗利率）
- 承認履歴
- バージョン履歴（タブ）

#### アクション
- PDF生成/ダウンロードボタン（承認済みのみ）
- 承認依頼ボタン（下書きのみ、作成者のみ）
- 承認/却下ボタン（承認待ちのみ、営業事務・管理者のみ）
- 改訂（新バージョン作成）ボタン
- 編集ボタン（下書きのみ）
- 削除ボタン（下書きのみ）

---

## 4. 承認フロー

### 4.1 承認フロー定義

```
下書き
  ↓ 営業が「承認依頼」ボタン押下
承認待ち
  ↓ 営業事務・管理者が「承認」
承認済み → PDF自動生成
  または
  ↓ 営業事務・管理者が「却下」
却下 → 営業に通知、再編集可能
```

### 4.2 承認ルート設定（approval_routes）

```sql
-- 例: 全見積に適用される承認ルート
INSERT INTO approval_routes (name, target_entity, requester_role, is_active)
VALUES ('標準見積承認', 'quote', '営業', true);

-- ステップ1: 営業事務が承認
INSERT INTO approval_route_steps (route_id, step_order, approver_role)
VALUES ('...', 1, '営業事務');
```

### 4.3 承認処理実装

```typescript
// 承認依頼
const requestApproval = async (quoteId: string) => {
  const supabase = createClient()
  
  // 見積ステータスを「承認待ち」に更新
  await supabase
    .from('quotes')
    .update({ approval_status: '承認待ち' })
    .eq('id', quoteId)

  // 承認インスタンス作成
  const { data: route } = await supabase
    .from('approval_routes')
    .select('*')
    .eq('target_entity', 'quote')
    .eq('is_active', true)
    .single()

  const { data: instance } = await supabase
    .from('quote_approval_instances')
    .insert({
      quote_id: quoteId,
      route_id: route.id,
      status: 'pending',
      requested_by: user.id,
    })
    .select()
    .single()

  // ステップ作成
  const { data: steps } = await supabase
    .from('approval_route_steps')
    .select('*')
    .eq('route_id', route.id)
    .order('step_order')

  await supabase
    .from('quote_approval_instance_steps')
    .insert(
      steps.map((step) => ({
        instance_id: instance.id,
        step_order: step.step_order,
        approver_role: step.approver_role,
        status: 'pending',
      }))
    )

  // 承認者にメール送信
  await sendEmail({
    type: 'quote_approval_request',
    ...
  })
}

// 承認処理
const approveQuote = async (quoteId: string) => {
  const supabase = createClient()
  
  // 見積ステータスを「承認済み」に更新
  await supabase
    .from('quotes')
    .update({
      approval_status: '承認済み',
      approved_by: user.id,
      approved_at: new Date().toISOString(),
    })
    .eq('id', quoteId)

  // 承認インスタンス更新
  await supabase
    .from('quote_approval_instances')
    .update({ status: 'approved' })
    .eq('quote_id', quoteId)

  // PDF生成
  await generateQuotePDF(quoteId)

  // 営業にメール送信
  await sendQuoteApprovalEmail(quoteId, '承認済み', user.display_name)
}

// 却下処理
const rejectQuote = async (quoteId: string, reason: string) => {
  const supabase = createClient()
  
  await supabase
    .from('quotes')
    .update({ approval_status: '却下' })
    .eq('id', quoteId)

  await supabase
    .from('quote_approval_instances')
    .update({
      status: 'rejected',
      rejection_reason: reason,
    })
    .eq('quote_id', quoteId)

  await sendQuoteApprovalEmail(quoteId, '却下', user.display_name, reason)
}
```

---

## 5. PDF生成

### 5.1 PDF生成フロー

```
承認完了
  ↓
Server Action: generateQuotePDF()
  ↓
@react-pdf/renderer で PDF生成
  ↓
Supabase Storageにアップロード
  ↓
quotesテーブルにpdf_url保存
  ↓
営業にダウンロードリンク通知
```

### 5.2 PDF生成実装（/lib/pdf/generate-quote-pdf.ts）

```typescript
'use server'

export async function generateQuotePDF(quoteId: string) {
  const supabase = await createClient()

  // 見積データ取得
  const { data: quote } = await supabase
    .from('quotes')
    .select(`
      *,
      project:projects(
        *,
        customer:customers(*),
        sales_rep:users!projects_sales_rep_id_fkey(*)
      ),
      items:quote_items(
        *,
        supplier:suppliers(supplier_name)
      )
    `)
    .eq('id', quoteId)
    .single()

  if (quote.approval_status !== '承認済み') {
    return { success: false, message: '承認済みの見積のみPDF生成可能' }
  }

  // PDF生成
  const pdfDoc = QuotePDF({ quote })
  const blob = await pdf(pdfDoc).toBlob()
  const buffer = Buffer.from(await blob.arrayBuffer())

  // Supabase Storageにアップロード
  const fileName = `${quote.quote_number}_v${quote.version}.pdf`
  const filePath = `quotes/${quoteId}/${fileName}`

  const { data: uploadData } = await supabase.storage
    .from('documents')
    .upload(filePath, buffer, {
      contentType: 'application/pdf',
      upsert: true,
    })

  // 公開URL取得
  const { data: urlData } = supabase.storage
    .from('documents')
    .getPublicUrl(filePath)

  // quotesテーブルにURL保存
  await supabase
    .from('quotes')
    .update({
      pdf_url: urlData.publicUrl,
      pdf_generated_at: new Date().toISOString(),
    })
    .eq('id', quoteId)

  return { success: true, url: urlData.publicUrl }
}
```

### 5.3 PDFコンポーネント（/components/quotes/quote-pdf.tsx）

```typescript
import { Document, Page, Text, View, StyleSheet } from '@react-pdf/renderer'

export function QuotePDF({ quote }) {
  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {/* ヘッダ */}
        <View style={styles.header}>
          <Text style={styles.title}>御見積書</Text>
          <Text>見積番号: {quote.quote_number}</Text>
          <Text>発行日: {formatDate(quote.issue_date)}</Text>
        </View>

        {/* 顧客情報 */}
        <View style={styles.section}>
          <Text>{quote.project.customer.customer_name} 御中</Text>
        </View>

        {/* 件名 */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>件名</Text>
          <Text>{quote.subject}</Text>
        </View>

        {/* 明細 */}
        <View style={styles.table}>
          <View style={styles.tableHeader}>
            <Text style={styles.col1}>No.</Text>
            <Text style={styles.col2}>品名</Text>
            <Text style={styles.col3}>説明</Text>
            <Text style={styles.col4}>数量</Text>
            <Text style={styles.col5}>単価</Text>
            <Text style={styles.col6}>金額</Text>
          </View>
          {quote.items.map((item, index) => (
            <View key={item.id} style={styles.tableRow}>
              <Text style={styles.col1}>{index + 1}</Text>
              <Text style={styles.col2}>{item.product_name}</Text>
              <Text style={styles.col3}>{item.description}</Text>
              <Text style={styles.col4}>{item.quantity}</Text>
              <Text style={styles.col5}>{formatCurrency(item.unit_price)}</Text>
              <Text style={styles.col6}>{formatCurrency(item.amount)}</Text>
            </View>
          ))}
        </View>

        {/* 合計 */}
        <View style={styles.totalSection}>
          <View style={styles.totalRow}>
            <Text>小計</Text>
            <Text>{formatCurrency(quote.total_amount)}</Text>
          </View>
          <View style={styles.grandTotal}>
            <Text style={styles.grandTotalLabel}>合計</Text>
            <Text style={styles.grandTotalValue}>{formatCurrency(quote.total_amount)}</Text>
          </View>
        </View>

        {/* 備考 */}
        {quote.notes && (
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>備考</Text>
            <Text>{quote.notes}</Text>
          </View>
        )}
      </Page>
    </Document>
  )
}
```

---

## 6. バージョン管理（改訂）

### 6.1 改訂フロー

```
既存見積（承認済み）
  ↓ 「改訂」ボタン押下
既存見積をコピー
  ↓
新バージョン作成（version + 1）
  ↓
previous_version_idに旧見積IDを設定
  ↓
ステータスは「下書き」
  ↓
編集・承認フロー
```

### 6.2 実装例

```typescript
const createRevision = async (originalQuoteId: string) => {
  const supabase = createClient()
  
  // 元の見積取得
  const { data: originalQuote } = await supabase
    .from('quotes')
    .select('*, items:quote_items(*)')
    .eq('id', originalQuoteId)
    .single()

  // 新バージョン作成
  const quoteNumber = await generateQuoteNumber()
  const { data: newQuote } = await supabase
    .from('quotes')
    .insert({
      project_id: originalQuote.project_id,
      quote_number: quoteNumber,
      version: originalQuote.version + 1,
      subject: originalQuote.subject,
      issue_date: new Date().toISOString().split('T')[0],
      valid_until: originalQuote.valid_until,
      total_amount: originalQuote.total_amount,
      total_cost: originalQuote.total_cost,
      gross_profit: originalQuote.gross_profit,
      approval_status: '下書き',
      previous_version_id: originalQuoteId,
      notes: originalQuote.notes,
      created_by: user.id,
    })
    .select()
    .single()

  // 明細コピー
  await supabase
    .from('quote_items')
    .insert(
      originalQuote.items.map((item) => ({
        quote_id: newQuote.id,
        line_number: item.line_number,
        product_name: item.product_name,
        description: item.description,
        quantity: item.quantity,
        unit_price: item.unit_price,
        amount: item.amount,
        supplier_id: item.supplier_id,
        cost_price: item.cost_price,
        cost_amount: item.cost_amount,
        gross_profit: item.gross_profit,
        requires_procurement: item.requires_procurement,
      }))
    )

  router.push(`/dashboard/quotes/${newQuote.id}`)
}
```

---

## 7. テスト

### 7.1 E2Eテスト

```typescript
// e2e/quote-creation.spec.ts

test('見積作成フロー', async ({ page }) => {
  await page.goto('/dashboard/quotes/new')
  
  // 案件選択
  await page.click('[data-testid="project-select"]')
  await page.click('text=PRJ-2025-0001')
  
  // 件名入力
  await page.fill('[name="subject"]', 'テスト見積')
  
  // 明細入力
  await page.fill('input[name="items.0.product_name"]', '商品A')
  await page.fill('input[name="items.0.quantity"]', '10')
  await page.fill('input[name="items.0.unit_price"]', '5000')
  
  // 登録
  await page.click('button[type="submit"]')
  
  // 見積詳細へリダイレクト
  await expect(page).toHaveURL(/\/dashboard\/quotes\/.+/)
  
  // 明細が表示されることを確認
  await expect(page.locator('text=商品A')).toBeVisible()
  await expect(page.locator('text=¥50,000')).toBeVisible()
})
```

---

## 8. パフォーマンス最適化

### 8.1 インデックス

```sql
CREATE INDEX idx_quotes_project_id ON quotes(project_id);
CREATE INDEX idx_quotes_quote_number ON quotes(quote_number);
CREATE INDEX idx_quotes_approval_status ON quotes(approval_status);
CREATE INDEX idx_quote_items_quote_id ON quote_items(quote_id);
```

---

## 9. 今後の拡張
- 見積テンプレート機能
- PDFフォーマットのカスタマイズ
- 発注書との自動連携
- 見積比較機能
- 顧客への見積提示（ポータル機能）
