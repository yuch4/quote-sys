# 計上管理機能・通知機能・レポート機能・マスタ管理機能・共通コンポーネント 詳細設計書

以下、残り5つの機能の詳細設計を記載します。

---

# 05. 計上管理機能

## 1. 機能概要
見積の全明細が入荷完了した案件について、営業が計上申請を行い、営業事務が承認することで売上計上を実現する。

## 2. データモデル

```sql
CREATE TABLE public.billing_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES public.projects(id),
  quote_id UUID NOT NULL REFERENCES public.quotes(id),
  billing_month DATE NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('申請中', '承認済', '却下', '計上完了')) DEFAULT '申請中',
  requested_by UUID NOT NULL REFERENCES public.users(id),
  requested_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  reviewed_by UUID REFERENCES public.users(id),
  reviewed_at TIMESTAMPTZ,
  rejection_reason TEXT,
  exported_to_sales_system BOOLEAN NOT NULL DEFAULT false,
  exported_to_notes BOOLEAN NOT NULL DEFAULT false,
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

## 3. 画面設計

### 3.1 営業ダッシュボード（/dashboard/billing）

**今月計上予定サマリー**
- 計上確定済: ○件 / ○○百万円
- 申請中: ○件 / ○○百万円
- 申請可能: ○件 / ○○百万円（緑色）
- 明細未完了: ○件 / ○○百万円（黄色）

**計上申請可否の自動判定**

```typescript
const canBill = (quote: Quote) => {
  // 全明細が入荷済みかチェック
  const allItemsReceived = quote.items.every(
    item => !item.requires_procurement || item.procurement_status === '入荷済'
  )
  
  // 全明細に出荷可能日が設定されているかチェック
  const allItemsHaveShipmentDate = quote.items.every(
    item => !item.requires_procurement || item.shipment_ready_date
  )
  
  return quote.approval_status === '承認済み' && allItemsReceived && allItemsHaveShipmentDate
}
```

**計上申請ボタン**
- 申請可能な案件のみボタン有効化
- 計上予定月を選択してダイアログで申請

### 3.2 計上申請一覧（営業事務）（/dashboard/billing/requests）

**表示項目**
- 申請日時、営業担当、案件名、顧客名
- 見積番号、売上金額、仕入金額、粗利、粗利率
- 明細完了率（例: 5/5件 100%）
- 最終入荷日、最短出荷可能日
- ステータス

**機能**
- フィルタ（営業担当、計上月、ステータス）
- 個別承認/一括承認
- 差し戻し + 理由入力

**承認処理**

```typescript
const approveBillingRequest = async (requestId: string) => {
  const supabase = createClient()
  
  await supabase
    .from('billing_requests')
    .update({
      status: '承認済',
      reviewed_by: user.id,
      reviewed_at: new Date().toISOString(),
    })
    .eq('id', requestId)

  // 営業にメール通知
  await sendBillingApprovalEmail(requestId, 'approved')
  
  toast.success('計上申請を承認しました')
}
```

### 3.3 計上確定・エクスポート

**月次計上確定リスト**
- 承認済み案件を計上月でフィルタ
- 売上・仕入・粗利の自動集計

**CSVエクスポート**

```typescript
import * as XLSX from 'xlsx'

const exportBillingData = async (month: string) => {
  const supabase = createClient()
  
  const { data: requests } = await supabase
    .from('billing_requests')
    .select(`
      *,
      project:projects(
        project_number,
        project_name,
        customer:customers(customer_name)
      ),
      quote:quotes(
        quote_number,
        total_amount,
        total_cost,
        gross_profit
      )
    `)
    .eq('status', '承認済')
    .eq('billing_month', `${month}-01`)

  const rows = requests.map(req => ({
    計上月: month,
    案件番号: req.project?.project_number,
    案件名: req.project?.project_name,
    顧客名: req.project?.customer?.customer_name,
    見積番号: req.quote?.quote_number,
    売上金額: req.quote?.total_amount,
    仕入金額: req.quote?.total_cost,
    粗利: req.quote?.gross_profit,
  }))

  const ws = XLSX.utils.json_to_sheet(rows)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, '計上データ')
  XLSX.writeFile(wb, `計上データ_${month}.xlsx`)
}
```

---

# 06. 通知機能

## 1. 機能概要
見積承認、計上申請、入荷完了などのイベント発生時に、関係者へメール・システム内通知を送信する。

## 2. データモデル

```sql
CREATE TABLE public.notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  link TEXT,
  is_read BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

## 3. 通知種別

| 種別 | トリガー | 受信者 |
|------|---------|--------|
| quote_approval_request | 見積承認依頼 | 営業事務・管理者 |
| quote_approved | 見積承認完了 | 営業担当 |
| quote_rejected | 見積却下 | 営業担当 |
| billing_request | 計上申請 | 営業事務・管理者 |
| billing_approved | 計上承認 | 営業担当 |
| billing_rejected | 計上却下 | 営業担当 |
| receiving_completed | 入荷完了 | 営業担当 |
| long_delay_alert | 長期未入荷アラート | 営業事務・管理者 |

## 4. 実装

### 4.1 メール送信（Resend）

```typescript
// lib/email/templates.ts

export const emailTemplates = {
  quote_approval_request: (data) => ({
    subject: `【承認依頼】見積 ${data.quoteNumber}`,
    html: `
      <h2>見積承認依頼</h2>
      <p>${data.salesRepName} さんから見積の承認依頼があります。</p>
      <ul>
        <li>見積番号: ${data.quoteNumber}</li>
        <li>案件名: ${data.projectName}</li>
        <li>顧客名: ${data.customerName}</li>
        <li>金額: ${formatCurrency(data.totalAmount)}</li>
      </ul>
      <p><a href="${data.quoteUrl}">見積を確認する</a></p>
    `,
  }),
  // 他のテンプレート...
}
```

### 4.2 システム内通知

```typescript
// 通知作成
const createNotification = async (userId: string, data: {
  type: string
  title: string
  message: string
  link?: string
}) => {
  const supabase = createClient()
  
  await supabase.from('notifications').insert({
    user_id: userId,
    type: data.type,
    title: data.title,
    message: data.message,
    link: data.link,
  })
}

// 未読通知取得
const getUnreadNotifications = async () => {
  const supabase = createClient()
  
  const { data } = await supabase
    .from('notifications')
    .select('*')
    .eq('user_id', user.id)
    .eq('is_read', false)
    .order('created_at', { ascending: false })

  return data || []
}

// 既読にする
const markAsRead = async (notificationId: string) => {
  const supabase = createClient()
  
  await supabase
    .from('notifications')
    .update({ is_read: true })
    .eq('id', notificationId)
}
```

### 4.3 通知ベルコンポーネント

```typescript
// components/notifications/notification-bell.tsx

export function NotificationBell() {
  const [unreadCount, setUnreadCount] = useState(0)
  const [notifications, setNotifications] = useState([])

  useEffect(() => {
    const fetchNotifications = async () => {
      const data = await getUnreadNotifications()
      setNotifications(data)
      setUnreadCount(data.length)
    }

    fetchNotifications()

    // Supabase Realtimeで自動更新
    const supabase = createClient()
    const channel = supabase
      .channel('notifications')
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'notifications',
        filter: `user_id=eq.${user.id}`,
      }, fetchNotifications)
      .subscribe()

    return () => {
      supabase.removeChannel(channel)
    }
  }, [])

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="icon" className="relative">
          <Bell className="h-5 w-5" />
          {unreadCount > 0 && (
            <span className="absolute top-0 right-0 h-4 w-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
              {unreadCount}
            </span>
          )}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-80">
        <DropdownMenuLabel>通知</DropdownMenuLabel>
        <DropdownMenuSeparator />
        {notifications.map((notification) => (
          <DropdownMenuItem key={notification.id} onClick={() => markAsRead(notification.id)}>
            <div>
              <p className="font-medium">{notification.title}</p>
              <p className="text-sm text-gray-600">{notification.message}</p>
            </div>
          </DropdownMenuItem>
        ))}
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

---

# 07. レポート・分析機能

## 1. 機能概要
売上、粗利、案件進捗などの各種統計データを可視化し、経営判断をサポートする。

## 2. 画面設計（/dashboard/reports）

### 2.1 売上分析
- **月次売上推移グラフ**（折れ線グラフ）
- **営業担当別売上ランキング**（棒グラフ + テーブル）
- **顧客別売上ランキング**
- **案件カテゴリ別売上**（円グラフ）

### 2.2 粗利分析
- **月次粗利推移グラフ**
- **営業担当別粗利率**
- **案件別粗利率ランキング**

### 2.3 案件進捗分析
- **ステータス別案件数**（円グラフ）
- **契約確度別見込売上**（積み上げ棒グラフ）

## 3. 実装例

```typescript
// app/(dashboard)/dashboard/reports/page.tsx

export default async function ReportsPage() {
  const supabase = await createClient()

  // 月次売上推移
  const { data: monthlySales } = await supabase.rpc('get_monthly_sales', {
    start_month: '2024-01-01',
    end_month: '2025-12-31',
  })

  // 営業担当別売上
  const { data: salesBySalesRep } = await supabase
    .from('billing_requests')
    .select(`
      quote:quotes(
        total_amount,
        project:projects(
          sales_rep:users!projects_sales_rep_id_fkey(id, display_name)
        )
      )
    `)
    .eq('status', '承認済')

  // グループ化
  const salesByRep = salesBySalesRep.reduce((acc, req) => {
    const repId = req.quote.project.sales_rep.id
    const repName = req.quote.project.sales_rep.display_name
    if (!acc[repId]) {
      acc[repId] = { name: repName, total: 0 }
    }
    acc[repId].total += Number(req.quote.total_amount)
    return acc
  }, {})

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold">レポート・分析</h1>

      {/* 月次売上推移 */}
      <Card>
        <CardHeader>
          <CardTitle>月次売上推移</CardTitle>
        </CardHeader>
        <CardContent>
          <LineChart data={monthlySales} />
        </CardContent>
      </Card>

      {/* 営業担当別売上 */}
      <Card>
        <CardHeader>
          <CardTitle>営業担当別売上</CardTitle>
        </CardHeader>
        <CardContent>
          <BarChart data={Object.values(salesByRep)} />
        </CardContent>
      </Card>
    </div>
  )
}
```

---

# 08. マスタ管理機能

## 1. 機能概要
顧客、仕入先、ユーザーのマスタデータを管理する。

## 2. 画面設計

### 2.1 顧客マスタ（/dashboard/settings/customers）
- 一覧、新規登録、編集、削除（論理削除）
- 顧客コード自動採番（CUS-00001形式）
- CSV一括インポート

### 2.2 仕入先マスタ（/dashboard/settings/suppliers）
- 一覧、新規登録、編集、削除（論理削除）
- 仕入先コード自動採番（SUP-00001形式）
- CSV一括インポート

### 2.3 ユーザー管理（/dashboard/settings/users）
- 一覧、新規登録、編集、無効化
- 役割設定（営業/営業事務/管理者）
- パスワードリセット

## 3. 実装例

```typescript
// 顧客作成
const createCustomer = async (data: CustomerFormData) => {
  const supabase = createClient()
  
  const { count } = await supabase
    .from('customers')
    .select('*', { count: 'exact', head: true })
  
  const customerCode = `CUS-${String((count || 0) + 1).padStart(5, '0')}`

  const { error } = await supabase
    .from('customers')
    .insert({
      customer_code: customerCode,
      customer_name: data.customer_name,
      contact_person: data.contact_person || null,
      email: data.email || null,
      phone: data.phone || null,
      address: data.address || null,
    })

  if (error) throw error
  toast.success('顧客を登録しました')
}
```

---

# 09. 共通コンポーネント設計

## 1. UIコンポーネント（/components/ui）

shadcn/uiベースのコンポーネント群:
- Button, Input, Select, Table, Card, Badge, Dialog, Tabs, など

## 2. レイアウトコンポーネント（/components/layout）

### 2.1 Sidebar（/components/layout/sidebar.tsx）
- ナビゲーションメニュー
- 役割に応じた表示制御

### 2.2 UserMenu（/components/layout/user-menu.tsx）
- ユーザー名、役割表示
- プロフィール、ログアウト

### 2.3 MobileSidebar（/components/layout/mobile-sidebar.tsx）
- モバイル用サイドバー（Sheetコンポーネント）

## 3. ユーティリティ関数（/lib/utils）

### 3.1 日付フォーマット

```typescript
export function formatDate(date: string | Date): string {
  const d = typeof date === 'string' ? new Date(date) : date
  return d.toLocaleDateString('ja-JP')
}

export function formatMonth(date: string | Date): string {
  const d = typeof date === 'string' ? new Date(date) : date
  return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}`
}
```

### 3.2 通貨フォーマット

```typescript
export function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('ja-JP', {
    style: 'currency',
    currency: 'JPY',
  }).format(amount)
}
```

### 3.3 粗利率計算

```typescript
export function calculateGrossProfitRate(
  totalAmount: number,
  totalCost: number
): number {
  if (totalAmount === 0) return 0
  return ((totalAmount - totalCost) / totalAmount) * 100
}
```

## 4. カスタムフック（/lib/hooks）

### 4.1 useCurrentUser

```typescript
export function useCurrentUser() {
  const [user, setUser] = useState<User | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const fetchUser = async () => {
      const supabase = createClient()
      const { data: { user: authUser } } = await supabase.auth.getUser()
      
      if (authUser) {
        const { data } = await supabase
          .from('users')
          .select('*')
          .eq('id', authUser.id)
          .single()
        
        setUser(data)
      }
      setLoading(false)
    }

    fetchUser()
  }, [])

  return { user, loading }
}
```

---

## 完了

以上、10個の詳細設計書（00〜09）の作成が完了しました。各機能の実装詳細、データモデル、画面設計、コード例が含まれています。
