# 見積システム - システム全体設計書

## 1. システム概要

### 1.1 目的
Excel依存型の見積・計上管理業務を統合し、データの一元管理と業務効率化を実現する見積管理システム。

### 1.2 対象ユーザー
- **営業**: 案件・見積作成、計上申請
- **営業事務**: 発注管理、入荷登録、計上承認
- **管理者**: 全機能 + ユーザー・マスタ管理

### 1.3 期待効果
- 作業時間90%削減（月間35-40時間 → 3-4時間）
- データ品質向上（転記ミス防止、整合性自動チェック）
- リアルタイム可視化（営業・事務双方の状況把握）

---

## 2. システムアーキテクチャ

### 2.1 技術スタック

| 領域 | 技術 | バージョン | 用途 |
|------|------|-----------|------|
| **フロントエンド** | Next.js | 16.0.1 | React Server Components、App Router |
| **言語** | TypeScript | 5.x | 型安全性の確保 |
| **UI** | Tailwind CSS | 4.x | スタイリング |
| **UI Components** | shadcn/ui | latest | 再利用可能なUIコンポーネント |
| **認証** | Supabase Auth | 2.78.0 | メール/パスワード認証、役割管理 |
| **データベース** | Supabase (PostgreSQL) | latest | リアルタイム機能、RLS |
| **ストレージ** | Supabase Storage | latest | PDF、添付ファイル |
| **状態管理** | React Hook Form + Zod | latest | フォームバリデーション |
| **PDF生成** | @react-pdf/renderer | 4.3.1 | 見積書PDF作成 |
| **メール送信** | Resend | 6.4.0 | 通知メール |
| **テスト** | Vitest + Playwright | latest | 単体・E2Eテスト |
| **デプロイ** | Vercel | - | ホスティング |

### 2.2 ディレクトリ構造

```
/Users/hisa/Develop/Quote-system/quote-sys/
├── app/                           # Next.js App Router
│   ├── (auth)/                    # 認証関連ページ
│   │   ├── layout.tsx             # 認証レイアウト
│   │   └── login/                 # ログインページ
│   ├── (dashboard)/               # ダッシュボード（認証後）
│   │   ├── layout.tsx             # ダッシュボードレイアウト
│   │   └── dashboard/             # 各機能ページ
│   │       ├── page.tsx           # ダッシュボードトップ
│   │       ├── projects/          # 案件管理
│   │       ├── quotes/            # 見積管理
│   │       ├── procurement/       # 発注・入荷管理
│   │       ├── billing/           # 計上管理
│   │       ├── approvals/         # 承認管理
│   │       ├── reports/           # レポート・分析
│   │       └── settings/          # 設定・マスタ管理
│   ├── api/                       # API Routes
│   │   ├── auth/                  # 認証API
│   │   ├── email/                 # メール送信API
│   │   └── cron/                  # 定期実行ジョブ
│   ├── layout.tsx                 # ルートレイアウト
│   ├── page.tsx                   # ルートページ（リダイレクト）
│   └── globals.css                # グローバルスタイル
├── components/                    # Reactコンポーネント
│   ├── ui/                        # shadcn/ui基本コンポーネント
│   ├── layout/                    # レイアウトコンポーネント
│   │   ├── sidebar.tsx            # サイドバー
│   │   ├── mobile-sidebar.tsx    # モバイルサイドバー
│   │   └── user-menu.tsx          # ユーザーメニュー
│   ├── projects/                  # 案件関連コンポーネント
│   ├── quotes/                    # 見積関連コンポーネント
│   ├── purchase-orders/           # 発注関連コンポーネント
│   ├── procurement/               # 調達関連コンポーネント
│   ├── notifications/             # 通知コンポーネント
│   └── profile/                   # プロフィールコンポーネント
├── lib/                           # ユーティリティ・ライブラリ
│   ├── supabase/                  # Supabaseクライアント
│   │   ├── client.ts              # クライアント用
│   │   ├── server.ts              # サーバー用
│   │   └── middleware.ts          # ミドルウェア
│   ├── email/                     # メール送信
│   │   ├── resend.ts              # Resend設定
│   │   ├── send.ts                # メール送信関数
│   │   └── templates.ts           # メールテンプレート
│   ├── pdf/                       # PDF生成
│   │   └── generate-quote-pdf.ts # 見積PDF生成
│   ├── projects/                  # 案件関連ユーティリティ
│   │   └── status.ts              # ステータス管理
│   ├── utils/                     # 汎用ユーティリティ
│   │   └── business.ts            # ビジネスロジック
│   └── utils.ts                   # 共通ユーティリティ
├── types/                         # TypeScript型定義
│   ├── database.ts                # データベース型
│   └── procurement-activity.ts    # 調達活動型
├── supabase/                      # Supabase設定
│   ├── migrations/                # マイグレーション
│   └── seed.sql                   # シードデータ
├── e2e/                           # E2Eテスト
├── docs/                          # ドキュメント
│   ├── REQUIREMENTS.md            # 要件定義書
│   └── design/                    # 詳細設計書（本ドキュメント）
├── public/                        # 静的ファイル
├── middleware.ts                  # Next.jsミドルウェア
├── package.json                   # パッケージ設定
├── tsconfig.json                  # TypeScript設定
├── next.config.ts                 # Next.js設定
└── tailwind.config.js             # Tailwind CSS設定
```

### 2.3 データフロー

```
ユーザー操作
    ↓
Next.js App Router (RSC)
    ↓
Supabase Client/Server
    ↓
PostgreSQL (RLS適用)
    ↓
Supabase Realtime (リアルタイム更新)
    ↓
UIへ反映
```

---

## 3. データベース設計

### 3.1 主要テーブル一覧

| テーブル名 | 説明 | 主要カラム |
|-----------|------|-----------|
| `users` | ユーザー | id, email, display_name, role, is_active |
| `customers` | 顧客マスタ | id, customer_code, customer_name |
| `suppliers` | 仕入先マスタ | id, supplier_code, supplier_name |
| `projects` | 案件 | id, project_number, customer_id, status |
| `quotes` | 見積 | id, quote_number, project_id, approval_status |
| `quote_items` | 見積明細 | id, quote_id, product_name, procurement_status |
| `purchase_orders` | 発注書 | id, purchase_order_number, supplier_id |
| `purchase_order_items` | 発注明細 | id, purchase_order_id, quote_item_id |
| `billing_requests` | 計上申請 | id, project_id, quote_id, status |
| `notifications` | 通知 | id, user_id, type, is_read |
| `approval_routes` | 承認ルート | id, target_entity, requester_role |
| `approval_route_steps` | 承認ステップ | id, route_id, step_order |
| `quote_approval_instances` | 見積承認インスタンス | id, quote_id, status |
| `purchase_order_approval_instances` | 発注承認インスタンス | id, purchase_order_id, status |
| `project_activities` | 案件活動記録 | id, project_id, activity_type |

### 3.2 ER図の主要関係

```
customers 1:N projects 1:N quotes 1:N quote_items
                                    ↓ 1:N
                                purchase_order_items N:1 purchase_orders N:1 suppliers

projects 1:N billing_requests

users 1:N projects (営業担当)
users 1:N quotes (作成者)
users 1:N notifications (受信者)
```

---

## 4. 認証・認可設計

### 4.1 認証方式
- **Supabase Auth**を使用したメール/パスワード認証
- JWTトークンによるセッション管理
- Server Component/Client Componentそれぞれに対応したクライアント

### 4.2 役割（Role）

| 役割 | 権限 |
|------|------|
| **営業** | 自分の案件・見積の作成・編集・閲覧、計上申請 |
| **営業事務** | 全案件閲覧、発注管理、入荷登録、計上承認、CSVエクスポート |
| **管理者** | 全権限 + ユーザー管理、マスタ管理 |

### 4.3 Row Level Security (RLS)

各テーブルにRLSポリシーを設定し、役割に応じたデータアクセス制御を実装。

```sql
-- 例: 営業は自分が担当する案件のみ閲覧可能
CREATE POLICY "営業は自分の案件のみ閲覧可能"
ON projects FOR SELECT
USING (
  auth.uid() = sales_rep_id OR
  EXISTS (
    SELECT 1 FROM users
    WHERE users.id = auth.uid()
    AND users.role IN ('営業事務', '管理者')
  )
);
```

---

## 5. 画面遷移図

```
/login (ログイン)
    ↓ ログイン成功
/dashboard (ダッシュボード)
    ├─ /dashboard/projects (案件一覧)
    │   ├─ /dashboard/projects/new (案件作成)
    │   ├─ /dashboard/projects/[id] (案件詳細)
    │   └─ /dashboard/projects/[id]/edit (案件編集)
    ├─ /dashboard/quotes (見積一覧)
    │   ├─ /dashboard/quotes/new (見積作成)
    │   └─ /dashboard/quotes/[id] (見積詳細)
    ├─ /dashboard/procurement (発注・入荷管理)
    │   ├─ /dashboard/procurement/pending (発注候補)
    │   ├─ /dashboard/procurement/purchase-orders (発注書一覧)
    │   ├─ /dashboard/procurement/receiving (入荷登録)
    │   └─ /dashboard/procurement/activity (活動記録)
    ├─ /dashboard/billing (計上管理)
    ├─ /dashboard/approvals (承認管理)
    ├─ /dashboard/reports (レポート・分析)
    └─ /dashboard/settings (設定・マスタ管理)
```

---

## 6. API設計

### 6.1 API Routes

| パス | メソッド | 説明 |
|------|---------|------|
| `/api/auth/callback` | GET | 認証コールバック |
| `/api/email/send` | POST | メール送信 |
| `/api/cron/daily-alerts` | GET | 日次アラート送信 |

### 6.2 Supabaseクライアント使用パターン

```typescript
// Server Component
import { createClient } from '@/lib/supabase/server'
const supabase = await createClient()

// Client Component
import { createClient } from '@/lib/supabase/client'
const supabase = createClient()
```

---

## 7. 非機能要件

### 7.1 パフォーマンス
- ページ初期表示: 2秒以内
- 一覧表示: 1000件まで1秒以内
- CSVエクスポート: 10000件まで5秒以内

### 7.2 セキュリティ
- HTTPS通信必須
- Supabase RLS による行レベルアクセス制御
- XSS、CSRF対策（Next.js標準機能）
- パスワードポリシー: 8文字以上

### 7.3 可用性
- Vercel + Supabaseで99.9%以上
- 自動バックアップ（Supabase標準機能）

### 7.4 保守性
- TypeScriptによる型安全性
- コンポーネントの再利用性
- テストカバレッジ70%以上

---

## 8. 外部連携

### 8.1 Resend（メール送信）
- 見積承認通知
- 計上申請通知
- 長期未入荷アラート

### 8.2 Supabase Storage
- 見積書PDF保存
- 添付ファイル保存

### 8.3 CSV出力
- 販売管理システム連携用
- ノーツ連携用
- Excelエクスポート（SheetJS）

---

## 9. エラーハンドリング

### 9.1 基本方針
- ユーザーにわかりやすいエラーメッセージ
- ログへの詳細記録
- トーストによる通知（sonner使用）

### 9.2 エラー種別

| 種別 | 対応 |
|------|------|
| バリデーションエラー | フォームフィールドへの表示 |
| 認証エラー | ログイン画面へリダイレクト |
| 権限エラー | 403エラーページ表示 |
| データベースエラー | エラーページ + ログ記録 |
| ネットワークエラー | リトライ促進メッセージ |

---

## 10. 今後の拡張予定

- モバイルアプリ対応
- 販売システム・ノーツとのAPI連携
- AI活用（見積金額の自動提案、異常検知）
- ワークフロービルダー（承認フローのカスタマイズ）
- 多言語対応

---

## 11. 関連ドキュメント

- [要件定義書](../REQUIREMENTS.md)
- [01_認証・認可機能設計](./01_認証・認可機能設計.md)
- [02_案件管理機能設計](./02_案件管理機能設計.md)
- [03_見積管理機能設計](./03_見積管理機能設計.md)
- [04_発注・入荷管理機能設計](./04_発注・入荷管理機能設計.md)
- [05_計上管理機能設計](./05_計上管理機能設計.md)
- [06_通知機能設計](./06_通知機能設計.md)
- [07_レポート・分析機能設計](./07_レポート・分析機能設計.md)
- [08_マスタ管理機能設計](./08_マスタ管理機能設計.md)
- [09_共通コンポーネント設計](./09_共通コンポーネント設計.md)
