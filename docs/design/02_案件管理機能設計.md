# 案件管理機能 詳細設計書

## 1. 機能概要

### 1.1 目的
営業案件の作成から受注、計上までのライフサイクルを一元管理し、案件情報の可視化とトラッキングを実現する。

### 1.2 主要機能
- 案件の新規作成・編集
- 案件一覧の表示・検索・フィルタリング
- 案件詳細表示
- ステータス管理（リード → 見積中 → 受注 → 計上OK → 計上済み）
- 案件活動記録（商談履歴、次回アクション）
- 契約確度管理（S/A/B/C/D）
- 見込売上・見込粗利の管理

---

## 2. データモデル

### 2.1 projectsテーブル

```sql
CREATE TABLE public.projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_number TEXT NOT NULL UNIQUE,
  customer_id UUID NOT NULL REFERENCES public.customers(id),
  project_name TEXT NOT NULL,
  category TEXT NOT NULL,
  department TEXT NOT NULL,
  sales_rep_id UUID NOT NULL REFERENCES public.users(id),
  status TEXT NOT NULL CHECK (status IN ('リード', '見積中', '受注', '計上OK', '計上済み', '失注', 'キャンセル')) DEFAULT 'リード',
  order_month DATE,
  accounting_month DATE,
  expected_sales DECIMAL(15, 2),
  expected_gross_profit DECIMAL(15, 2),
  contract_probability TEXT NOT NULL CHECK (contract_probability IN ('S', 'A', 'B', 'C', 'D')) DEFAULT 'B',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### 2.2 project_activitiesテーブル

```sql
CREATE TABLE public.project_activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
  activity_date DATE NOT NULL,
  activity_type TEXT NOT NULL CHECK (activity_type IN ('訪問', '電話', 'メール', 'オンライン', 'その他')),
  subject TEXT NOT NULL,
  details TEXT,
  next_action TEXT,
  next_action_due_date DATE,
  created_by UUID NOT NULL REFERENCES public.users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### 2.3 TypeScript型定義

```typescript
export type ProjectStatus =
  | 'リード'
  | '見積中'
  | '受注'
  | '計上OK'
  | '計上済み'
  | '失注'
  | 'キャンセル'

export type ContractProbability = 'S' | 'A' | 'B' | 'C' | 'D'

export interface Project {
  id: string
  project_number: string
  customer_id: string
  project_name: string
  category: string
  department: string
  sales_rep_id: string
  status: ProjectStatus
  order_month: string | null
  accounting_month: string | null
  expected_sales: number | null
  expected_gross_profit: number | null
  contract_probability: ContractProbability
  created_at: string
  updated_at: string
  // リレーション
  customer?: Customer
  sales_rep?: User
  quotes?: Quote[]
}

export interface ProjectActivity {
  id: string
  project_id: string
  activity_date: string
  activity_type: '訪問' | '電話' | 'メール' | 'オンライン' | 'その他'
  subject: string
  details: string | null
  next_action: string | null
  next_action_due_date: string | null
  created_by: string
  created_at: string
  updated_at: string
  // リレーション
  created_by_user?: User
}
```

---

## 3. 画面設計

### 3.1 案件一覧画面（/dashboard/projects）

#### 3.1.1 表示項目
- 案件番号
- 案件名
- 顧客名
- カテゴリ
- 営業担当
- ステータス（バッジ表示）
- 契約確度
- 見込売上
- 受注月
- 作成日

#### 3.1.2 機能
- **検索**: 案件名、顧客名、案件番号で全文検索
- **フィルタ**:
  - 営業担当（ドロップダウン）
  - ステータス（チェックボックス）
  - カテゴリ（ドロップダウン）
  - 受注月範囲（月ピッカー）
- **ソート**: 各カラムでソート可能
- **ページネーション**: 1ページ20件
- **アクション**:
  - 新規案件作成ボタン
  - 案件詳細へ遷移（行クリック）

#### 3.1.3 実装例

```typescript
// app/(dashboard)/dashboard/projects/page.tsx

import { createClient } from '@/lib/supabase/server'
import { ProjectFilters } from '@/components/projects/project-filters'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { Badge } from '@/components/ui/badge'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'

export default async function ProjectsPage({
  searchParams,
}: {
  searchParams: Promise<{ [key: string]: string | undefined }>
}) {
  const params = await searchParams
  const supabase = await createClient()

  // フィルタ条件の取得
  const search = params.search || ''
  const status = params.status?.split(',') || []
  const salesRep = params.sales_rep || ''
  const page = parseInt(params.page || '1')
  const limit = 20

  // クエリ構築
  let query = supabase
    .from('projects')
    .select(`
      *,
      customer:customers(customer_name),
      sales_rep:users!projects_sales_rep_id_fkey(display_name)
    `, { count: 'exact' })

  // 検索条件
  if (search) {
    query = query.or(`project_name.ilike.%${search}%,project_number.ilike.%${search}%`)
  }

  // ステータスフィルタ
  if (status.length > 0) {
    query = query.in('status', status)
  }

  // 営業担当フィルタ
  if (salesRep) {
    query = query.eq('sales_rep_id', salesRep)
  }

  // ページネーション
  const from = (page - 1) * limit
  const to = from + limit - 1
  query = query.range(from, to)

  // ソート
  query = query.order('created_at', { ascending: false })

  const { data: projects, count, error } = await query

  const totalPages = Math.ceil((count || 0) / limit)

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">案件一覧</h1>
          <p className="text-gray-600 mt-2">全{count || 0}件</p>
        </div>
        <Link href="/dashboard/projects/new">
          <Button>新規案件作成</Button>
        </Link>
      </div>

      <ProjectFilters />

      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>案件番号</TableHead>
            <TableHead>案件名</TableHead>
            <TableHead>顧客名</TableHead>
            <TableHead>カテゴリ</TableHead>
            <TableHead>営業担当</TableHead>
            <TableHead>ステータス</TableHead>
            <TableHead>契約確度</TableHead>
            <TableHead className="text-right">見込売上</TableHead>
            <TableHead>受注月</TableHead>
            <TableHead>作成日</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {projects?.map((project) => (
            <TableRow key={project.id}>
              <TableCell>
                <Link href={`/dashboard/projects/${project.id}`} className="text-blue-600 hover:underline">
                  {project.project_number}
                </Link>
              </TableCell>
              <TableCell>{project.project_name}</TableCell>
              <TableCell>{project.customer?.customer_name}</TableCell>
              <TableCell>{project.category}</TableCell>
              <TableCell>{project.sales_rep?.display_name}</TableCell>
              <TableCell>
                <Badge variant={getStatusBadgeVariant(project.status)}>
                  {project.status}
                </Badge>
              </TableCell>
              <TableCell>
                <Badge variant="outline">{project.contract_probability}</Badge>
              </TableCell>
              <TableCell className="text-right">
                {project.expected_sales ? `¥${project.expected_sales.toLocaleString()}` : '-'}
              </TableCell>
              <TableCell>
                {project.order_month ? formatMonth(project.order_month) : '-'}
              </TableCell>
              <TableCell>{formatDate(project.created_at)}</TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>

      {/* ページネーション */}
    </div>
  )
}
```

### 3.2 案件作成画面（/dashboard/projects/new）

#### 3.2.1 入力項目
- **顧客** (必須): ドロップダウン選択 + 新規登録ボタン
- **案件名** (必須): テキスト入力
- **カテゴリ** (必須): テキスト入力 (例: オフィス機器)
- **部門** (必須): テキスト入力 (例: 営業部)
- **営業担当** (必須): ドロップダウン選択（デフォルト: ログインユーザー）
- **受注月**: 月ピッカー
- **計上月**: 月ピッカー
- **見込売上**: 数値入力
- **見込粗利**: 数値入力
- **契約確度** (必須): ドロップダウン選択（S/A/B/C/D）（デフォルト: B）

#### 3.2.2 バリデーション
- 必須項目チェック
- 見込売上・見込粗利の数値チェック（0以上）
- 計上月 >= 受注月のチェック

#### 3.2.3 案件番号の自動採番

```typescript
const generateProjectNumber = async () => {
  const supabase = createClient()
  const year = new Date().getFullYear()
  const { count } = await supabase
    .from('projects')
    .select('*', { count: 'exact', head: true })
  
  const nextNumber = (count || 0) + 1
  return `PRJ-${year}-${String(nextNumber).padStart(4, '0')}`
}

// 例: PRJ-2025-0001
```

#### 3.2.4 顧客の新規登録（ダイアログ）

```typescript
// 顧客登録ダイアログ内での処理
const handleSaveCustomer = async () => {
  const supabase = createClient()
  
  // 顧客コード自動生成
  const { count } = await supabase
    .from('customers')
    .select('*', { count: 'exact', head: true })
  const customerCode = `CUS-${String((count || 0) + 1).padStart(5, '0')}`

  const { data, error } = await supabase
    .from('customers')
    .insert({
      customer_code: customerCode,
      customer_name: formData.customer_name,
      contact_person: formData.contact_person || null,
      email: formData.email || null,
      phone: formData.phone || null,
      address: formData.address || null,
    })
    .select()
    .single()

  if (error) throw error

  // 顧客リスト再読込
  await loadCustomers()
  
  // 新規顧客を選択状態にする
  setFormData(prev => ({ ...prev, customer_id: data.id }))
}
```

### 3.3 案件詳細画面（/dashboard/projects/[id]）

#### 3.3.1 表示内容

**基本情報カード**
- 案件番号、案件名、ステータス（バッジ）
- 顧客名、カテゴリ、部門
- 営業担当、受注月、計上月
- 見込売上、見込粗利、契約確度
- 作成日時、更新日時

**紐づく見積一覧（タブ）**
- 見積番号、承認ステータス、発行日、金額
- 見積詳細へのリンク

**発注書一覧（タブ）**
- 発注番号、仕入先、ステータス、金額、発注日
- 発注詳細へのリンク

**活動記録（タブ）**
- 活動日、活動種別、件名、詳細
- 次回アクション、期限
- 新規活動登録フォーム

#### 3.3.2 アクション
- 編集ボタン（自分の案件 or 営業事務・管理者のみ）
- 新規見積作成ボタン
- 新規発注書作成ボタン
- 活動記録追加フォーム

#### 3.3.3 実装例

```typescript
// app/(dashboard)/dashboard/projects/[id]/page.tsx

export default async function ProjectDetailPage({ 
  params 
}: { 
  params: Promise<{ id: string }> 
}) {
  const { id } = await params
  const supabase = await createClient()

  const { data: project, error } = await supabase
    .from('projects')
    .select(`
      *,
      customer:customers(*),
      sales_rep:users!projects_sales_rep_id_fkey(*),
      quotes:quotes(
        id,
        quote_number,
        approval_status,
        total_amount,
        issue_date,
        purchase_orders:purchase_orders(
          id,
          purchase_order_number,
          status,
          approval_status,
          total_cost,
          supplier:suppliers(supplier_name)
        )
      )
    `)
    .eq('id', id)
    .single()

  if (error || !project) {
    notFound()
  }

  const { data: activities } = await supabase
    .from('project_activities')
    .select(`
      *,
      created_by_user:users(display_name)
    `)
    .eq('project_id', id)
    .order('activity_date', { ascending: false })

  return (
    <div className="space-y-6">
      {/* 基本情報カード */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle>{project.project_name}</CardTitle>
            <Badge variant={getStatusBadgeVariant(project.status)}>
              {project.status}
            </Badge>
          </div>
          <CardDescription>{project.project_number}</CardDescription>
        </CardHeader>
        <CardContent>
          <dl className="grid grid-cols-2 gap-4">
            <div>
              <dt className="text-sm text-gray-600">顧客名</dt>
              <dd className="font-medium">{project.customer?.customer_name}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">カテゴリ</dt>
              <dd className="font-medium">{project.category}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">営業担当</dt>
              <dd className="font-medium">{project.sales_rep?.display_name}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">契約確度</dt>
              <dd>
                <Badge variant="outline">{project.contract_probability}</Badge>
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">見込売上</dt>
              <dd className="font-medium">
                {project.expected_sales ? `¥${project.expected_sales.toLocaleString()}` : '-'}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">見込粗利</dt>
              <dd className="font-medium">
                {project.expected_gross_profit ? `¥${project.expected_gross_profit.toLocaleString()}` : '-'}
              </dd>
            </div>
          </dl>
        </CardContent>
      </Card>

      {/* タブ */}
      <Tabs defaultValue="quotes">
        <TabsList>
          <TabsTrigger value="quotes">見積一覧</TabsTrigger>
          <TabsTrigger value="purchase-orders">発注書一覧</TabsTrigger>
          <TabsTrigger value="activities">活動記録</TabsTrigger>
        </TabsList>

        <TabsContent value="quotes">
          {/* 見積一覧 */}
        </TabsContent>

        <TabsContent value="purchase-orders">
          {/* 発注書一覧 */}
        </TabsContent>

        <TabsContent value="activities">
          {/* 活動記録 + 新規登録フォーム */}
          <ProjectActivityForm projectOptions={[...]} />
        </TabsContent>
      </Tabs>
    </div>
  )
}
```

### 3.4 案件編集画面（/dashboard/projects/[id]/edit）

#### 3.4.1 編集可能項目
- 案件名
- カテゴリ
- 部門
- 営業担当（管理者のみ）
- ステータス
- 受注月
- 計上月
- 見込売上
- 見込粗利
- 契約確度

#### 3.4.2 編集権限
- 営業: 自分が担当する案件のみ編集可能
- 営業事務: 全案件編集可能
- 管理者: 全案件編集可能

---

## 4. ステータス管理

### 4.1 ステータス定義

| ステータス | 説明 | 遷移条件 |
|-----------|------|---------|
| **リード** | 初期状態、商談開始前 | 案件作成時 |
| **見積中** | 見積作成中 | 見積作成開始 |
| **受注** | 受注確定 | 見積承認完了 |
| **計上OK** | 計上可能状態 | 全明細が入荷済み |
| **計上済み** | 計上完了 | 計上申請承認完了 |
| **失注** | 受注失敗 | 手動設定 |
| **キャンセル** | 案件キャンセル | 手動設定 |

### 4.2 ステータス自動更新ロジック

```typescript
// lib/projects/status.ts

export function deriveProjectStatus(project: Project): ProjectStatus {
  // 手動で失注・キャンセルに設定されている場合はそのまま
  if (project.status === '失注' || project.status === 'キャンセル') {
    return project.status
  }

  // 見積が存在する場合
  if (project.quotes && project.quotes.length > 0) {
    const hasApprovedQuote = project.quotes.some(q => q.approval_status === '承認済み')
    
    if (hasApprovedQuote) {
      // 承認済み見積あり → 受注
      return '受注'
    } else {
      // 見積作成中 → 見積中
      return '見積中'
    }
  }

  // 見積がない場合 → リード
  return 'リード'
}
```

### 4.3 バッジカラー定義

```typescript
const getStatusBadgeVariant = (status: ProjectStatus) => {
  switch (status) {
    case 'リード': return 'outline'
    case '見積中': return 'secondary'
    case '受注': return 'default'
    case '計上OK': return 'secondary'
    case '計上済み': return 'default'
    case '失注': return 'destructive'
    case 'キャンセル': return 'outline'
    default: return 'secondary'
  }
}
```

---

## 5. 契約確度管理

### 5.1 確度定義

| 確度 | 説明 | 用途 |
|------|------|------|
| **S** | ほぼ確定（90-100%） | 受注確実な案件 |
| **A** | 高い（70-89%） | 受注見込みが高い |
| **B** | 中間（40-69%） | 通常の案件 |
| **C** | 低い（10-39%） | 受注見込みが低い |
| **D** | 未確定（0-9%） | 情報収集段階 |

### 5.2 確度別フィルタリング

レポート画面で、確度別の見込売上集計に使用。

```typescript
// 確度S・Aの案件の見込売上合計
const highProbabilityRevenue = projects
  .filter(p => ['S', 'A'].includes(p.contract_probability))
  .reduce((sum, p) => sum + (p.expected_sales || 0), 0)
```

---

## 6. 活動記録管理

### 6.1 活動種別
- 訪問
- 電話
- メール
- オンライン（Web会議）
- その他

### 6.2 活動記録フォーム

```typescript
// components/procurement/project-activity-form.tsx

interface ProjectActivityFormData {
  project_id: string
  activity_date: string
  activity_type: '訪問' | '電話' | 'メール' | 'オンライン' | 'その他'
  subject: string
  details: string
  next_action: string
  next_action_due_date: string
}

const handleSubmit = async (data: ProjectActivityFormData) => {
  const supabase = createClient()
  
  const { error } = await supabase
    .from('project_activities')
    .insert({
      project_id: data.project_id,
      activity_date: data.activity_date,
      activity_type: data.activity_type,
      subject: data.subject,
      details: data.details || null,
      next_action: data.next_action || null,
      next_action_due_date: data.next_action_due_date || null,
      created_by: user.id,
    })

  if (error) throw error
  
  toast.success('活動を記録しました')
  router.refresh()
}
```

### 6.3 活動記録一覧表示

```typescript
// 活動記録の表示（案件詳細ページ内）
{activities?.map((activity) => (
  <Card key={activity.id}>
    <CardHeader>
      <div className="flex items-center justify-between">
        <CardTitle className="text-base">
          {activity.subject}
        </CardTitle>
        <Badge variant="outline">{activity.activity_type}</Badge>
      </div>
      <CardDescription>
        {formatDate(activity.activity_date)} | {activity.created_by_user?.display_name}
      </CardDescription>
    </CardHeader>
    {activity.details && (
      <CardContent>
        <p className="text-sm whitespace-pre-wrap">{activity.details}</p>
        {activity.next_action && (
          <div className="mt-4 p-3 bg-blue-50 rounded">
            <p className="text-sm font-medium text-blue-900">次回アクション</p>
            <p className="text-sm text-blue-800 mt-1">{activity.next_action}</p>
            {activity.next_action_due_date && (
              <p className="text-xs text-blue-600 mt-1">
                期限: {formatDate(activity.next_action_due_date)}
              </p>
            )}
          </div>
        )}
      </CardContent>
    )}
  </Card>
))}
```

---

## 7. RLSポリシー

### 7.1 projectsテーブル

```sql
-- 営業は自分の案件のみ閲覧可能、営業事務・管理者は全て閲覧可能
CREATE POLICY "営業は自分の案件のみ閲覧可能"
ON projects FOR SELECT
USING (
  auth.uid() = sales_rep_id OR
  EXISTS (
    SELECT 1 FROM users
    WHERE users.id = auth.uid()
    AND users.role IN ('営業事務', '管理者')
  )
);

-- 営業は案件作成可能
CREATE POLICY "営業は案件作成可能"
ON projects FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1 FROM users
    WHERE users.id = auth.uid()
    AND users.is_active = true
  )
);

-- 営業は自分の案件のみ更新可能、営業事務・管理者は全て更新可能
CREATE POLICY "営業は自分の案件のみ更新可能"
ON projects FOR UPDATE
USING (
  auth.uid() = sales_rep_id OR
  EXISTS (
    SELECT 1 FROM users
    WHERE users.id = auth.uid()
    AND users.role IN ('営業事務', '管理者')
  )
);
```

### 7.2 project_activitiesテーブル

```sql
-- 案件を閲覧できるユーザーは活動記録も閲覧可能
CREATE POLICY "案件権限で活動記録閲覧"
ON project_activities FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM projects
    WHERE projects.id = project_activities.project_id
    AND (
      auth.uid() = projects.sales_rep_id OR
      EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role IN ('営業事務', '管理者')
      )
    )
  )
);

-- ログインユーザーは活動記録作成可能
CREATE POLICY "ログインユーザーは活動記録作成可能"
ON project_activities FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1 FROM users
    WHERE users.id = auth.uid()
    AND users.is_active = true
  )
);
```

---

## 8. パフォーマンス最適化

### 8.1 インデックス

```sql
-- 案件番号での検索を高速化
CREATE INDEX idx_projects_project_number ON projects(project_number);

-- 営業担当でのフィルタを高速化
CREATE INDEX idx_projects_sales_rep_id ON projects(sales_rep_id);

-- ステータスでのフィルタを高速化
CREATE INDEX idx_projects_status ON projects(status);

-- 作成日時でのソートを高速化
CREATE INDEX idx_projects_created_at ON projects(created_at DESC);

-- 活動記録の案件IDでの検索を高速化
CREATE INDEX idx_project_activities_project_id ON project_activities(project_id);
```

### 8.2 データ取得の最適化
- 一覧表示では必要最小限のカラムのみSELECT
- リレーションは1回のクエリでまとめて取得
- ページネーションによる取得件数制限

---

## 9. テスト

### 9.1 E2Eテスト

```typescript
// e2e/project-flow.spec.ts

test('案件作成フロー', async ({ page }) => {
  await page.goto('/dashboard/projects/new')
  
  // 顧客選択
  await page.click('[data-testid="customer-select"]')
  await page.click('text=テスト顧客')
  
  // 案件名入力
  await page.fill('[name="project_name"]', 'テスト案件')
  
  // カテゴリ入力
  await page.fill('[name="category"]', 'オフィス機器')
  
  // 部門入力
  await page.fill('[name="department"]', '営業部')
  
  // 登録
  await page.click('button[type="submit"]')
  
  // 案件一覧へリダイレクトされることを確認
  await expect(page).toHaveURL(/\/dashboard\/projects$/)
  
  // 作成した案件が表示されることを確認
  await expect(page.locator('text=テスト案件')).toBeVisible()
})
```

---

## 10. 今後の拡張

- カンバンビュー（ドラッグ&ドロップでステータス変更）
- ガントチャート（受注月・計上月の可視化）
- 案件複製機能
- 一括インポート（CSV）
- カスタムフィールド追加機能
- 案件テンプレート機能
