# 見積システム開発タスク一覧

## 実装完了サマリー

### ✅ Phase 1: 基盤構築 - **完了**
- 開発環境セットアップ（Next.js 15, Supabase, shadcn/ui）
- Supabaseプロジェクト作成（Tokyo region, Project ID: fcqaounlphlmnlhzrqmj）
- データベーススキーマ構築（8テーブル + RLS + インデックス）
- 認証機能実装（ログイン/ログアウト、ミドルウェア）
- ダッシュボードレイアウト（サイドバー、ヘッダー）
- マスタ管理機能
  - 顧客マスタ（一覧・登録・編集）
  - 仕入先マスタ（一覧・登録・編集）
  - ユーザー管理（一覧・登録・編集）
- 案件管理機能（一覧・登録・編集・詳細）

### ✅ Phase 2: 見積機能 - **完了**
- 見積一覧ページ（フィルタ・検索機能付き）
- 見積作成ページ（動的明細、リアルタイム計算）
- 見積詳細ページ（全情報表示）
- 見積編集ページ（下書きのみ編集可）
- 見積承認フロー
  - 承認依頼、承認/却下機能
  - 下書きに戻す機能
  - 役割ベースの権限制御
- 見積書PDF生成
  - @react-pdf/rendererでPDF生成
  - Supabase Storageへアップロード
  - PDFダウンロード機能
- 見積改訂機能
  - バージョン管理（v1, v2, v3...）
  - 改訂版作成
  - バージョン履歴表示

---

## Phase 1: 基盤構築 (2-3週間) ✅ **完了**

### 開発環境のセットアップ ✅
- ✅ 必要パッケージのインストール
  - Supabase クライアント (@supabase/supabase-js, @supabase/ssr)
  - shadcn/ui のセットアップ
  - @react-pdf/renderer (見積書PDF生成)
  - lucide-react (アイコン)
  - その他UI関連

### Supabaseプロジェクトの初期設定 ✅
- ✅ Supabaseプロジェクト作成（Tokyo region）
- ✅ 環境変数設定 (.env.local)
- ✅ Supabaseクライアントの設定ファイル作成
  - `/lib/supabase/client.ts` (ブラウザ用)
  - `/lib/supabase/server.ts` (サーバー用)
  - `/lib/supabase/middleware.ts` (ミドルウェア用)
- ✅ マイグレーションファイル作成

### データベーススキーマの構築 ✅
- ✅ usersテーブル作成
- ✅ customersテーブル作成
- ✅ suppliersテーブル作成
- ✅ projectsテーブル作成
- ✅ quotesテーブル作成
- ✅ quote_itemsテーブル作成
- ✅ procurement_logsテーブル作成
- ✅ billing_requestsテーブル作成
- ✅ Row Level Security (RLS) ポリシー設定
- ✅ インデックス・外部キー制約の設定

### 認証機能の実装 ✅
- ✅ ログインページ作成
- ✅ ログアウト機能
- ✅ 認証ミドルウェア実装
- ✅ 役割ベースのアクセス制御
- ⏭️ パスワードリセット機能（後回し）

### 基本レイアウト・ナビゲーションの実装 ✅
- ✅ ダッシュボードレイアウト作成
- ✅ サイドバーナビゲーション
- ✅ ヘッダー(ユーザー情報、ログアウト)
- ✅ レスポンシブ対応

### マスタ管理機能 ✅
- ✅ 顧客マスタ
  - ✅ 一覧表示
  - ✅ 登録フォーム
  - ✅ 編集フォーム
  - ✅ 検索・フィルタ機能（名前・ステータス）
- ✅ 仕入先マスタ
  - ✅ 一覧表示
  - ✅ 登録フォーム
  - ✅ 編集フォーム
  - ✅ 検索・フィルタ機能（名前・ステータス）
- ✅ ユーザー管理
  - ✅ 一覧表示
  - ✅ 登録フォーム
  - ✅ 編集フォーム
  - ✅ ステータス管理
  - ✅ 役割設定

---

## Phase 2: 見積機能 (3-4週間) ✅ **完了**

### 案件管理機能 ✅
- ✅ 案件一覧ページ
  - ✅ 一覧表示(テーブル)
  - ✅ ソート機能
  - ✅ 検索機能(案件名、顧客名)
- ✅ 案件登録ページ
  - ✅ 入力フォーム作成
  - ✅ 案件番号自動採番
- ✅ 案件編集ページ
- ✅ 案件詳細ページ
  - ✅ 基本情報表示
  - ✅ 編集ボタン

### 見積作成・編集機能 ✅
- ✅ 見積作成ページ
  - ✅ ヘッダ情報入力フォーム
  - ✅ 明細入力UI(動的行追加・削除)
  - ✅ 金額自動計算機能（金額、仕入金額、粗利）
  - ✅ リアルタイム合計表示
  - ✅ 仕入先選択（明細ごと）
  - ✅ 仕入要チェックボックス
- ✅ 見積編集ページ
  - ✅ 下書き状態のみ編集可
  - ✅ 既存明細の読込・更新
- ✅ 見積一覧ページ
  - ✅ 一覧表示（案件・顧客情報含む）
  - ✅ 承認ステータスバッジ
  - ✅ フィルタ機能
- ✅ 見積詳細ページ
  - ✅ 基本情報・金額情報・案件情報表示
  - ✅ 明細テーブル表示
  - ✅ 粗利・粗利率表示

### 見積承認フロー ✅
- ✅ 承認依頼機能（下書き→承認待ち）
- ✅ 承認/却下機能（営業事務・管理者のみ）
- ✅ 下書きに戻す機能（却下後）
- ✅ ApprovalActionsコンポーネント
  - ✅ 役割と状態に応じたボタン表示
  - ✅ AlertDialogで確認
  - ✅ Server Actionsで状態更新

### 見積書PDF生成 ✅
- ✅ PDFテンプレート作成（`/components/quotes/quote-pdf.tsx`）
  - ✅ ヘッダー情報
  - ✅ 顧客情報
  - ✅ 案件情報
  - ✅ 明細テーブル
  - ✅ 合計金額
  - ✅ 備考・フッター
- ✅ PDF生成機能実装（`/lib/pdf/generate-quote-pdf.ts`）
- ✅ Supabase Storageへのアップロード（documentsバケット）
- ✅ PDFダウンロード機能
- ✅ PDFGenerateButtonコンポーネント

### 見積改訂機能 ✅
- ✅ 既存見積のコピー機能
- ✅ バージョン管理
  - ✅ 自動バージョン番号採番
  - ✅ 見積番号形式: `Q-YYYY-XXXX-vN`
  - ✅ previous_version_idで旧バージョン参照
- ✅ 履歴表示（VersionHistoryコンポーネント）
  - ✅ 全バージョン一覧
  - ✅ 現在バージョンのハイライト
  - ✅ 各バージョンへのリンク
- ✅ 改訂ページ（`/dashboard/quotes/[id]/revise`）
  - ✅ 承認済みのみ改訂可
  - ✅ 元明細の継承
  - ✅ 明細の編集・追加・削除
  - ✅ 新バージョンを下書きで作成

---

## Phase 3: 発注・入荷管理 (2-3週間) 🔄 **次のフェーズ**

### 発注待ち一覧
- [ ] 発注待ち明細の抽出・表示
  - [ ] 承認済み見積の明細から仕入要=trueを抽出
  - [ ] 発注済みステータスでフィルタリング
  - [ ] 案件・顧客・仕入先情報の表示
- [ ] フィルタ・検索機能
  - [ ] 仕入先でフィルタ
  - [ ] 案件名・品名で検索
  - [ ] 期間フィルタ
- [ ] 複数選択機能（チェックボックス）
- [ ] 一括発注登録
  - [ ] procurement_logsテーブルへ登録
  - [ ] 発注日・担当者記録
- [ ] CSVエクスポート（仕入先別発注リスト）

### 入荷登録機能
- [ ] 入荷登録フォーム
  - [ ] 発注済み明細の検索
  - [ ] 入荷日入力
  - [ ] 入荷数量入力（部分入荷対応）
  - [ ] 備考入力
- [ ] 検索機能(案件名、顧客名、品名)
- [ ] 明細ステータス更新
  - [ ] procurement_statusを「入荷済み」に更新
- [ ] 営業担当への通知（入荷完了通知）

### 進捗ダッシュボード
- [ ] 発注済・未入荷一覧
  - [ ] 発注日からの経過日数表示
  - [ ] 仕入先別グルーピング
- [ ] 入荷待ち日数表示
  - [ ] 7日以上：黄色アラート
  - [ ] 14日以上：赤色アラート
- [ ] 出荷可能予定日表示
- [ ] アラート機能（長期未入荷の通知）

---

## Phase 4: 計上管理 (3-4週間)

### 営業ダッシュボード
- [ ] 今月計上予定サマリー表示
  - [ ] 自分の案件の計上可能・不可リスト
  - [ ] 月次目標との比較
- [ ] 計上申請可否の自動判定
  - [ ] 全明細の入荷完了チェック
  - [ ] 出荷完了チェック
- [ ] 申請可能案件リスト
  - [ ] 計上可能な案件のみ表示
  - [ ] 案件ごとの詳細情報
- [ ] 明細完了状況の可視化
  - [ ] プログレスバー表示
  - [ ] 未完了明細の詳細表示
- [ ] 計上申請フォーム
  - [ ] 計上予定日入力
  - [ ] 金額確認
  - [ ] 申請理由・備考

### 計上申請一覧(営業事務)
- [ ] 申請一覧表示
  - [ ] 申請日・営業担当・案件・金額
  - [ ] ステータスバッジ
- [ ] 詳細情報表示(明細ごとの入荷状況)
  - [ ] 全明細の入荷日確認
  - [ ] 出荷状況確認
- [ ] フィルタ機能
  - [ ] 営業担当でフィルタ
  - [ ] 期間フィルタ
  - [ ] ステータスフィルタ
- [ ] 承認/差し戻し機能
  - [ ] 承認：billing_requestsのステータス更新
  - [ ] 差し戻し：理由入力必須
- [ ] 通知機能（承認・差し戻し通知）

### 計上確定・エクスポート
- [ ] 月次計上確定リスト
  - [ ] 承認済み申請の一覧
  - [ ] 月次集計表示
- [ ] 売上・仕入・粗利の集計
  - [ ] 営業担当別
  - [ ] 顧客別
  - [ ] 月別推移
- [ ] 販売管理システム連携用CSV出力
  - [ ] 売上データフォーマット
  - [ ] 仕入データフォーマット
- [ ] ノーツ連携用CSV出力
  - [ ] 案件情報フォーマット
- [ ] エクスポート履歴記録
  - [ ] 出力日時・担当者記録
  - [ ] 再出力防止チェック

---

## Phase 5: 通知・レポート (2週間)

### メール通知機能
- [ ] Resend セットアップ
  - [ ] API Key設定
  - [ ] メールテンプレート作成
- [ ] 見積承認依頼メール
- [ ] 見積承認完了メール
- [ ] 計上申請メール
- [ ] 計上承認/却下メール
- [ ] 入荷完了メール

### システム内通知
- [ ] 通知データモデル作成（notificationsテーブル）
- [ ] ベルアイコン・未読件数表示
- [ ] 通知一覧ドロワー
  - [ ] 通知タイプ別アイコン
  - [ ] タイムスタンプ表示
  - [ ] リンク機能
- [ ] 既読管理
  - [ ] クリックで既読
  - [ ] 一括既読機能

### レポート機能
- [ ] 売上分析
  - [ ] 月次売上推移グラフ（Chart.js or Recharts）
  - [ ] 営業担当別売上ランキング
  - [ ] 顧客別売上ランキング
  - [ ] 案件カテゴリ別売上
- [ ] 粗利分析
  - [ ] 月次粗利推移
  - [ ] 営業担当別粗利率
  - [ ] 案件別粗利率ランキング
  - [ ] 仕入先別粗利分析
- [ ] ダッシュボード
  - [ ] KPI表示（売上・粗利・案件数）
  - [ ] 今月の目標達成率
  - [ ] アラート表示

---

## Phase 6: テスト・改善 (2週間)

### テスト実装
- [ ] Vitest セットアップ
- [ ] 単体テスト作成
  - [ ] ユーティリティ関数
  - [ ] バリデーション
  - [ ] 計算ロジック
- [ ] Playwright セットアップ
- [ ] E2Eテストシナリオ作成
  - [ ] ログイン〜見積作成
  - [ ] 見積承認フロー
  - [ ] 発注〜入荷登録
  - [ ] 計上申請〜承認
- [ ] E2Eテスト実装

### パフォーマンス最適化
- [ ] ページ読み込み速度計測（Lighthouse）
- [ ] データベースクエリ最適化
  - [ ] N+1問題の解消
  - [ ] 適切なselect句の使用
- [ ] インデックスチューニング
  - [ ] スロークエリの分析
  - [ ] 複合インデックスの追加
- [ ] 画像・アセット最適化
  - [ ] Next.js Image最適化
  - [ ] フォント最適化

### ユーザビリティ改善
- [ ] ユーザーフィードバック収集
- [ ] UI/UX改善
  - [ ] ローディング状態の改善
  - [ ] エラー処理の改善
  - [ ] 操作性の向上
- [ ] エラーメッセージの改善
  - [ ] 分かりやすいメッセージ
  - [ ] 解決策の提示
- [ ] ヘルプ・ガイド作成
  - [ ] 各画面の使い方
  - [ ] よくある質問

---

## Phase 7: 移行・運用開始 (1週間)

### データ移行
- [ ] 既存Excelデータの整理
  - [ ] データクレンジング
  - [ ] フォーマット統一
- [ ] データ移行スクリプト作成
  - [ ] 顧客マスタ移行
  - [ ] 仕入先マスタ移行
  - [ ] 過去案件移行（必要に応じて）
- [ ] 移行データの検証
  - [ ] データ整合性チェック
  - [ ] サンプルデータでの動作確認

### ドキュメント作成
- [ ] ユーザーマニュアル作成
  - [ ] 営業担当向け
  - [ ] 営業事務向け
  - [ ] 管理者向け
- [ ] 管理者向けマニュアル作成
  - [ ] マスタ管理
  - [ ] ユーザー管理
  - [ ] バックアップ・復元
- [ ] 運用手順書作成
  - [ ] 日次業務フロー
  - [ ] 月次業務フロー
  - [ ] トラブルシューティング

### 本番リリース準備
- [ ] 本番環境構築(Vercel)
  - [ ] プロジェクト作成
  - [ ] ドメイン設定
- [ ] 環境変数設定
  - [ ] Supabase接続情報
  - [ ] Resend API Key
  - [ ] その他シークレット
- [ ] セキュリティチェック
  - [ ] RLSポリシー確認
  - [ ] 環境変数の保護
  - [ ] CORS設定
- [ ] バックアップ設定
  - [ ] Supabase自動バックアップ有効化
  - [ ] 手動バックアップ手順確立

### ユーザートレーニング・リリース
- [ ] ユーザートレーニング実施
  - [ ] ハンズオン形式
  - [ ] 質疑応答セッション
- [ ] 本番リリース
  - [ ] リリースチェックリスト実行
  - [ ] スモークテスト
- [ ] 初期サポート
  - [ ] 問い合わせ対応
  - [ ] バグ修正
  - [ ] 使い方サポート

---

## 現在の優先順位

### 🎉 完了済み
- ✅ Phase 1: 基盤構築（認証・DB・マスタ・案件管理）
- ✅ Phase 2: 見積機能（作成・編集・承認・PDF・改訂）

### 🔴 次の優先タスク（Phase 3: 発注・入荷管理）
1. 発注待ち一覧ページの実装
2. 発注登録機能（procurement_logsテーブル活用）
3. 入荷登録機能
4. 進捗ダッシュボード

### 🟡 中期タスク（Phase 4-5）
- 計上管理機能（営業ダッシュボード、計上申請）
- 通知機能（メール・システム内）
- レポート機能（売上・粗利分析）

### 🟢 長期タスク（Phase 6-7）
- テスト実装（単体・E2E）
- パフォーマンス最適化
- データ移行・本番リリース

---

## 技術スタック

### フロントエンド
- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **UIライブラリ**: shadcn/ui (Tailwind CSS)
- **アイコン**: lucide-react
- **PDF生成**: @react-pdf/renderer

### バックエンド
- **BaaS**: Supabase
  - **データベース**: PostgreSQL
  - **認証**: Supabase Auth
  - **ストレージ**: Supabase Storage
  - **RLS**: Row Level Security有効
- **API**: Server Actions / Server Components

### インフラ
- **ホスティング**: Vercel（予定）
- **DB地域**: Tokyo (ap-northeast-1)
- **環境**: Development（ローカル）

### 開発ツール
- **パッケージマネージャー**: npm
- **Linter**: ESLint
- **Git**: GitHub

---

## ディレクトリ構造

```
quote-sys/
├── app/
│   ├── (auth)/
│   │   └── login/              # ログインページ
│   ├── (dashboard)/
│   │   └── dashboard/
│   │       ├── settings/       # マスタ管理
│   │       │   ├── customers/  # 顧客マスタ
│   │       │   ├── suppliers/  # 仕入先マスタ
│   │       │   └── users/      # ユーザー管理
│   │       ├── projects/       # 案件管理
│   │       └── quotes/         # 見積管理
│   │           ├── [id]/
│   │           │   ├── page.tsx      # 見積詳細
│   │           │   ├── edit/         # 見積編集
│   │           │   ├── revise/       # 見積改訂
│   │           │   └── actions.ts    # Server Actions
│   │           ├── new/              # 見積作成
│   │           └── page.tsx          # 見積一覧
│   ├── layout.tsx
│   └── page.tsx
├── components/
│   ├── ui/                     # shadcn/uiコンポーネント
│   └── quotes/                 # 見積関連コンポーネント
│       ├── approval-actions.tsx
│       ├── pdf-generate-button.tsx
│       ├── quote-pdf.tsx
│       └── version-history.tsx
├── lib/
│   ├── supabase/              # Supabase設定
│   │   ├── client.ts
│   │   ├── server.ts
│   │   └── middleware.ts
│   └── pdf/                   # PDF生成
│       └── generate-quote-pdf.ts
├── supabase/
│   └── migrations/            # DBマイグレーション
│       └── 20250101000000_initial_schema.sql
├── types/
│   └── database.ts            # 型定義
├── middleware.ts              # 認証ミドルウェア
├── .env.local                 # 環境変数
└── todo.md                    # このファイル
```

---

## データベーステーブル

1. **users** - ユーザー情報（営業・営業事務・管理者）
2. **customers** - 顧客マスタ
3. **suppliers** - 仕入先マスタ
4. **projects** - 案件情報
5. **quotes** - 見積ヘッダ（承認状況、バージョン管理）
6. **quote_items** - 見積明細（品名、数量、単価、粗利）
7. **procurement_logs** - 発注・入荷履歴
8. **billing_requests** - 計上申請

---

## 実装済み主要機能

### 認証・権限
- ✅ メールアドレス・パスワード認証
- ✅ 役割ベースアクセス制御（営業・営業事務・管理者）
- ✅ セッション管理（Cookie-based）
- ✅ ミドルウェアによる保護

### マスタ管理
- ✅ 顧客CRUD（一覧・登録・編集・検索）
- ✅ 仕入先CRUD（一覧・登録・編集・検索）
- ✅ ユーザー管理CRUD（一覧・登録・編集）

### 案件管理
- ✅ 案件CRUD（一覧・登録・編集・詳細）
- ✅ 案件番号自動採番（P-YYYY-XXXX形式）

### 見積管理
- ✅ 見積作成（動的明細、リアルタイム計算）
- ✅ 見積編集（下書きのみ）
- ✅ 見積詳細表示
- ✅ 見積一覧（フィルタ・検索）
- ✅ 承認フロー（承認依頼→承認/却下→下書き戻し）
- ✅ PDF生成・ダウンロード
- ✅ 見積改訂（バージョン管理・履歴表示）

### 計算機能
- ✅ 明細ごとの金額計算（数量×単価）
- ✅ 仕入金額計算（数量×仕入単価）
- ✅ 粗利計算（金額-仕入金額）
- ✅ 合計金額・合計仕入・総粗利
- ✅ 粗利率表示

---

## 次回実装予定の機能詳細

### Phase 3: 発注・入荷管理

#### 1. 発注待ち一覧ページ (`/dashboard/procurement/pending`)
**目的**: 承認済み見積の中から仕入要=trueの明細を抽出し、発注管理を行う

**画面構成**:
- フィルタエリア
  - 仕入先選択
  - 案件名検索
  - 期間フィルタ
- 明細一覧テーブル
  - チェックボックス（一括選択用）
  - 案件番号・案件名
  - 顧客名
  - 品名・説明
  - 数量
  - 仕入先
  - 仕入単価
  - ステータス（未発注/発注済/入荷済）
- アクションボタン
  - 「選択した明細を発注」ボタン
  - 「CSVエクスポート」ボタン

**実装内容**:
```typescript
// 発注待ち明細の取得クエリ
const { data } = await supabase
  .from('quote_items')
  .select(`
    *,
    quote:quotes!inner(
      quote_number,
      approval_status,
      project:projects(
        project_number,
        project_name,
        customer:customers(customer_name)
      )
    ),
    supplier:suppliers(supplier_name)
  `)
  .eq('requires_procurement', true)
  .eq('quote.approval_status', '承認済み')
  .is('procurement_status', null) // または 'or(procurement_status.is.null,procurement_status.eq.未発注)'
```

#### 2. 発注登録機能
**目的**: 選択した明細を一括で発注済みにする

**処理フロー**:
1. チェックされた明細IDを取得
2. procurement_logsテーブルに発注記録を登録
3. quote_itemsのprocurement_statusを「発注済み」に更新
4. 発注日・担当者を記録

**Server Action例**:
```typescript
export async function registerProcurement(itemIds: string[]) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  
  // procurement_logsに登録
  const logs = itemIds.map(itemId => ({
    quote_item_id: itemId,
    action_type: '発注',
    action_date: new Date().toISOString(),
    user_id: user.id,
  }))
  
  await supabase.from('procurement_logs').insert(logs)
  
  // statusを更新
  await supabase
    .from('quote_items')
    .update({ procurement_status: '発注済み' })
    .in('id', itemIds)
}
```

#### 3. 入荷登録ページ (`/dashboard/procurement/receiving`)
**目的**: 発注済み明細の入荷を登録

**画面構成**:
- 検索エリア
  - 案件名検索
  - 品名検索
  - 仕入先フィルタ
- 発注済み明細一覧
  - 発注日
  - 経過日数（発注からの日数）
  - 案件情報
  - 品名・数量
  - 仕入先
- 入荷登録フォーム
  - 入荷日
  - 入荷数量（部分入荷対応）
  - 備考

**実装内容**:
- 発注済みで未入荷の明細を表示
- 入荷登録時にprocurement_statusを「入荷済み」に更新
- procurement_logsに入荷記録を追加
- 営業担当にメール通知（Phase 5で実装）

---

## 想定される課題と対策

### 1. Supabase Storage設定
**課題**: PDFアップロード用のStorageバケットが未作成
**対策**: Supabaseダッシュボードで`documents`バケットを作成し、公開設定を行う

### 2. RLSポリシーの調整
**課題**: procurement_logsなど新しいテーブルのRLSが未設定
**対策**: Phase 3実装前にRLSポリシーを追加するマイグレーションを作成

### 3. パフォーマンス
**課題**: 見積一覧で多数のJOINが発生し、遅延の可能性
**対策**: 
- 必要最小限のカラムのみselect
- ページネーション実装
- インデックスの最適化

### 4. エラーハンドリング
**課題**: 現在alert()を使用しており、UX的に改善の余地あり
**対策**: Phase 5でtoast通知やエラーバウンダリを実装

---

## メモ・備考

### Git コミット履歴
- `feat: Phase 1完了 - 認証・マスタ・案件管理`
- `feat: 見積一覧・作成機能実装`
- `feat: 見積詳細・編集機能実装`
- `feat: 見積承認フロー実装`
- `feat: 見積書PDF生成機能実装`
- `feat: 見積改訂機能とバージョン履歴表示実装`

### 開発サーバー起動コマンド
```bash
npm run dev
```

### Supabase情報
- Project ID: `fcqaounlphlmnlhzrqmj`
- Region: `ap-northeast-1` (Tokyo)
- URL: `https://fcqaounlphlmnlhzrqmj.supabase.co`

### 今後の拡張アイデア
- [ ] 見積テンプレート機能（よく使う明細のテンプレート化）
- [ ] 一括見積作成（複数案件を一度に）
- [ ] 見積比較機能（バージョン間のdiff表示）
- [ ] モバイルアプリ対応
- [ ] AIによる見積金額提案
- [ ] Slack/Teams通知連携
